<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Memory Management &mdash; Intel® QuickAssist Technology  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/qat.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=16ad857a"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=d10d0bba"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Modes of Operation" href="infrastructure_modes_of_operation.html" />
    <link rel="prev" title="Service Instances" href="infrastructure_service_instances.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Intel® QuickAssist Technology
          </a>
              <div class="version">
                Hardware Version 2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../qat_general/legal.html">Legal Notices &amp; Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/terminology.html">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/In-Tree/index.html">Release Notes - In-Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/Linux/2.X/index.html">Release Notes - Linux*</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/VMware/2.X/index.html">Release Notes - VMware*</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GSG/2.X/index.html">Getting Started Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Programmer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">About this Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="infrastructure_index.html">Infrastructure</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="infrastructure_queue_pairs.html">Queues and Queue Pairs</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_service_instances.html">Service Instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#shared-virtual-memory">Shared Virtual Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dma-able-memory">DMA-able Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="#memory-type-determination">Memory Type Determination</a></li>
<li class="toctree-l4"><a class="reference internal" href="#buffer-formats">Buffer Formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="#huge-pages">Huge Pages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_modes_of_operation.html">Modes of Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_load_balancing.html">Load Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_debugability.html">Debugability</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_heartbeat.html">Heartbeat</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_device_telemetry.html">Telemetry</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_ratelimiting.html">Rate Limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_power_management.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_ras.html">Reliability, Availability, and Stability (RAS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="acceleration_driver.html">Acceleration Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration_files_index.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="services_index.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="apis_index.html">Supported APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualization.html">Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Secure Architecture Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="revision_history.html">Revision History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../VIRT/index.html">Virtualization Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PERF/index.html">Performance Optimization Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qatlib/index.html">QATlib User’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_PG/index.html">API Programmer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/contact.html">Contact &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/collateral_list.html">Documentation &amp; Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel® QuickAssist Technology</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Programmer’s Guide</a></li>
          <li class="breadcrumb-item"><a href="infrastructure_index.html">Infrastructure</a></li>
      <li class="breadcrumb-item active">Memory Management</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="memory-management">
<span id="qat-2-0-pg-infrastructure-memory-management"></span><h1>Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this heading"></a></h1>
<p>This section describes memory management requirements for submitting buffers to the QAT hardware.</p>
<section id="shared-virtual-memory">
<span id="qat-2-0-pg-shared-virtual-memory"></span><h2>Shared Virtual Memory<a class="headerlink" href="#shared-virtual-memory" title="Permalink to this heading"></a></h2>
<p>Shared Virtual Memory (SVM) is a new feature in QAT 2.0 hardware. In QAT 1.x hardware, memory needs to be
submitted to the hardware as pinned and physically contiguous memory. In QAT 2.0, SVM allows direct submission
of an applications buffer, thus removing the memcpy cycle cost, cache thrashing, and memory bandwidth.
The SVM feature enables passing virtual addresses to the QAT hardware for processing acceleration requests.</p>
<p>With SVM:</p>
<ul class="simple">
<li><p>Virtually contiguous (can also deal with Scatter Gather Lists of virtually addressed buffers).</p></li>
<li><p>Virtually addressed.</p></li>
<li><p>Can tolerate page faults but Pinning (i.e. locked, guaranteed resident in physical memory) is recommended for performance.</p></li>
</ul>
<section id="svm-kernel-requirements">
<span id="qat-2-0-pg-svm-kernel-requirements"></span><h3>SVM Kernel Requirements<a class="headerlink" href="#svm-kernel-requirements" title="Permalink to this heading"></a></h3>
<p>In order to use SVM, ensure that kernel version v6.1 or higher is used. Alternatively verify the following kernel patches are applied.</p>
<ul class="simple">
<li><p>81c95fbaebfa5990c3c786c8c3e87426a33106fe</p></li>
<li><p>e65a6897be5e4939d477c4969a05e12d90b08409</p></li>
</ul>
<p>Verification can be done with the following steps:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>tag<span class="w"> </span>--contains<span class="w"> </span>81c95fbaebfa5990c3c786c8c3e87426a33106fe
git<span class="w"> </span>tag<span class="w"> </span>--contains<span class="w"> </span>e65a6897be5e4939d477c4969a05e12d90b08409
</pre></div>
</div>
</div></blockquote>
<p>This requirement provides mitigation for the issue <a class="reference internal" href="../RN/Linux/2.X/updates.html#qat-2-0-rn-svm-issue"><span class="std std-ref">QAT20-23616</span></a> described in the Release Notes.</p>
<p>The following kernel boot parameters need to be defined in order to utilize SVM.</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">intel_iommu=on,sm_on</span></code></p>
</div></blockquote>
<p>Refer to <a class="reference internal" href="configuration_files_generalsection.html#qat-2-0-pg-svm-configuration-parameters"><span class="std std-ref">Shared Virtual Memory Parameters</span></a> for details on QAT configuration files updates required to support SVM.</p>
</section>
</section>
<section id="dma-able-memory">
<h2>DMA-able Memory<a class="headerlink" href="#dma-able-memory" title="Permalink to this heading"></a></h2>
<p>If SVM is not enabled, Memory passed to Intel<sup>®</sup> QuickAssist Technology hardware must be DMA’able.</p>
<ul class="simple">
<li><p>Physically contiguous (can also deal with Scatter Gather Lists).</p></li>
<li><p>Physically addressed.</p>
<ul>
<li><p>If VT-d is enabled (e.g. in virtualized system), then Intel IOMMU will translate to host physical addresses as needed.</p></li>
</ul>
</li>
<li><p>Pinned (i.e. locked, guaranteed resident in physical memory).</p></li>
</ul>
<p>Intel provides a User Space DMA-able Memory (USDM) component (kernel driver and corresponding user space library) which
allocates/frees DMA-able memory, mapped to user space, performs virtual to physical address translation on memory allocated by this library</p>
<p>This component is used by the sample code supplied with the user space library.</p>
</section>
<section id="memory-type-determination">
<h2>Memory Type Determination<a class="headerlink" href="#memory-type-determination" title="Permalink to this heading"></a></h2>
<p>QAT 2.0 hardware offers the application to use virtual memory directly to sending the acceleration requests and saving
the memory copy overhead.
However, different SVM configurations will result in different memory types. The QAT package offers memory management library called User Space DMAable
Memory(USDM) to help user space applications using the pinned memory.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><strong>SVMEnabled</strong></p></td>
<td><p><strong>ATEnabled</strong></p></td>
<td><p><strong>Memory Type</strong></p></td>
</tr>
<tr class="row-even"><td><p>FALSE(0)</p></td>
<td><p>FALSE(0)</p></td>
<td><p>Pinned Memory (USDM)</p></td>
</tr>
<tr class="row-odd"><td><p>TRUE(1)</p></td>
<td><p>FALSE(0)</p></td>
<td><p>Pinned Memory (USDM)</p></td>
</tr>
<tr class="row-even"><td><p>FALSE(0)</p></td>
<td><p>TRUE(1)</p></td>
<td><p>Invalid configuration</p></td>
</tr>
<tr class="row-odd"><td><p>TRUE(1)</p></td>
<td><p>TRUE(1)</p></td>
<td><p>Pinned Memory (USDM) or Dynamic Memory (malloc/
zalloc/mmap…)</p></td>
</tr>
</tbody>
</table>
</section>
<section id="buffer-formats">
<h2>Buffer Formats<a class="headerlink" href="#buffer-formats" title="Permalink to this heading"></a></h2>
<p>Data buffers are passed across the API interface in one of the following formats:</p>
<ul class="simple">
<li><p>Flat Buffers represent a single region of physically contiguous memory.</p></li>
<li><p>Scatter-Gather Lists (SGL) are essentially an array of flat buffers, for cases where the memory is not all physically contiguous.</p></li>
</ul>
<section id="flat-buffers">
<h3>Flat Buffers<a class="headerlink" href="#flat-buffers" title="Permalink to this heading"></a></h3>
<p>Flat buffers are represented by the type <code class="docutils literal notranslate"><span class="pre">CpaFlatBuffer</span></code>, defined in the file <code class="docutils literal notranslate"><span class="pre">cpa.h</span></code>. It consists of two fields:</p>
<ul class="simple">
<li><p>Data pointer <code class="docutils literal notranslate"><span class="pre">pData</span></code>: points to the start address of the data or payload. The data pointer is a virtual address; however, the actual data pointed to is required to be in contiguous and DMAable physical memory. This buffer type is typically used when simple, unchained buffers are needed.</p></li>
<li><p>Length of this buffer: <code class="docutils literal notranslate"><span class="pre">dataLenInBytes</span></code> specified in bytes.</p></li>
</ul>
<p>For data plane APIs (<code class="docutils literal notranslate"><span class="pre">cpa_sym_dp.h</span></code> and <code class="docutils literal notranslate"><span class="pre">cpa_dc_dp.h</span></code>), a flat buffer is represented by
the type <code class="docutils literal notranslate"><span class="pre">CpaPhysFlatBuffer</span></code>, also defined in <code class="docutils literal notranslate"><span class="pre">cpa.h</span></code>. This is similar to the
<code class="docutils literal notranslate"><span class="pre">CpaFlatBuffer</span></code> structure; the difference is that, in this case, the data pointer,
<code class="docutils literal notranslate"><span class="pre">bufferPhysAddr</span></code>, is a physical address rather than a virtual address.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/flat_buffer_updated.png"><img alt="../_images/flat_buffer_updated.png" src="../_images/flat_buffer_updated.png" style="width: 595px; height: 211px;" /></a>
</figure>
</section>
<section id="scatter-gather-list-sgl-buffers">
<h3>Scatter-Gather List (SGL) Buffers<a class="headerlink" href="#scatter-gather-list-sgl-buffers" title="Permalink to this heading"></a></h3>
<p>A scatter-gather list is defined by the type <code class="docutils literal notranslate"><span class="pre">CpaBufferList</span></code>, also defined in the file
<code class="docutils literal notranslate"><span class="pre">cpa.h</span></code>. This buffer structure is typically used where more than one flat buffer can be
provided to a particular API. The buffer list contains four fields, as follows:</p>
<ul class="simple">
<li><p>The number of buffers in the list.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pBuffers</span></code>: pointer to an unbounded array of flat buffers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UserData</span></code>: an opaque field; is not read or modified internally by the API. This field could be used to provide a pointer back into an application data structure, providing the context of the call.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pMetaData</span></code>: pointer to metadata required by the API:</p>
<ul>
<li><p>The metadata is required for internal use by the API. The memory for this buffer needs to be allocated by the client as contiguous data. The size of this metadata buffer is obtained by calling <code class="docutils literal notranslate"><span class="pre">cpaCyBufferListGetMetaSize</span></code> for crypto, <code class="docutils literal notranslate"><span class="pre">cpaBufferLists</span></code>, and <code class="docutils literal notranslate"><span class="pre">cpaDcBufferListGetMetaSize</span></code> for data compression.</p></li>
<li><p>The memory required to hold the <code class="docutils literal notranslate"><span class="pre">CpaBufferList</span></code> structure and the array of flat buffers is not required to be physically contiguous. However, the flat buffer data pointers and the metadata pointer are required to reference physically contiguous DMAable memory.</p></li>
<li><p>There is a performance impact when using scatter-gather lists instead of flat buffers. Refer to the <span class="xref std std-ref">Performance Optimization Guide</span> for additional information.</p></li>
<li><p>Scatter-Gather list (SGL) buffers should not have more than 256 entries.</p></li>
</ul>
</li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/scatter_gather_updated.png"><img alt="../_images/scatter_gather_updated.png" src="../_images/scatter_gather_updated.png" style="width: 742px; height: 393px;" /></a>
</figure>
<p>For data plane APIs (<code class="docutils literal notranslate"><span class="pre">cpa_sym_dp.h</span></code> and <code class="docutils literal notranslate"><span class="pre">cpa_dc_dp.h</span></code>) a region of memory that is not
physically contiguous is described using the <code class="docutils literal notranslate"><span class="pre">CpaPhysBufferList</span></code> structure. This is
similar to the <code class="docutils literal notranslate"><span class="pre">CpaBufferList</span></code> structure; the difference, in this case, the individual flat
buffers are represented using physical rather than virtual addresses.</p>
</section>
</section>
<section id="huge-pages">
<h2>Huge Pages<a class="headerlink" href="#huge-pages" title="Permalink to this heading"></a></h2>
<p>The included User space DMAable Memory driver <code class="docutils literal notranslate"><span class="pre">usdm_drv.ko</span></code> supports 2MB pages. This allows direct access to
main memory by devices other than the CPU and the actual supported maximum memory size in one individual allocation
when huge pages is enabled is 2MB - 5KB. Where the 5KB is used for memory management for the memory driver. The use
of 2MB pages provides benefits, but also requires additional configuration. Use of this capability assumes that a
sufficient number of huge pages are allocated in the operating system for the particular use case and configuration.</p>
<p>Here are some example use cases:</p>
<ul>
<li><p>Default settings applied:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">modprobe usdm_drv.ko</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Set maximum amount of Non-uniform Memory Access (NUMA) type memory that the User Space DMAable Memory (USDM) driver can allocate to 32MB for all processes. Huge pages are disabled:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">modprobe usdm_drv.ko max_mem_numa=32768</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>Set maximum number of huge pages that the USDM can allocate to 50 in total and 5 per process:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">modprobe usdm_drv.ko max_huge_pages=50 max_huge_pages_per_process=5</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This configuration works for up to the first 10 processes.</p>
</div>
<p>Here are examples of invalid use cases to avoid:</p>
<ul>
<li><p>This is erroneous configuration, maximum number of huge pages that USDM can allocate is 3 totals: 3 for a first process, 0 for the next processes:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">insmod ./usdm_drv.ko max_huge_pages=3 max_huge_pages_per_process=5</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>This command results in huge pages being disabled because <code class="docutils literal notranslate"><span class="pre">max_huge_pages</span></code> is 0 by default:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">insmod ./usdm_drv.ko max_huge_pages_per_process=5</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>This command results in huge pages being disabled because <code class="docutils literal notranslate"><span class="pre">max_huge_pages_per_process</span></code> is 0 by default:</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">insmod ./usdm_drv.ko max_huge_pages=5</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The use of huge pages may not be supported for all use cases. For instance, depending on the driver version, some limitations may exist for an Input/Output Memory Management Unit (IOMMU).</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="infrastructure_service_instances.html" class="btn btn-neutral float-left" title="Service Instances" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="infrastructure_modes_of_operation.html" class="btn btn-neutral float-right" title="Modes of Operation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Intel Corporation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>