<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Heartbeat &mdash; Intel® QuickAssist Technology  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/qat.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Telemetry" href="infrastructure_device_telemetry.html" />
    <link rel="prev" title="Debugability" href="infrastructure_debugability.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Intel® QuickAssist Technology
          </a>
              <div class="version">
                Hardware Version 2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../qat_general/legal.html">Legal Notices &amp; Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/terminology.html">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GSG/2.X/index.html">Getting Started Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Programmer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">About this Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="infrastructure_index.html">Infrastructure</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="infrastructure_queue_pairs.html">Queues and Queue Pairs</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_service_instances.html">Service Instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_memory_management.html">Memory Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_modes_of_operation.html">Modes of Operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_load_balancing.html">Load Balancing</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_debugability.html">Debugability</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Heartbeat</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#heartbeat-operation">Heartbeat Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#incorporating-heartbeat-into-intel-qat-applications">Incorporating Heartbeat into Intel<sup>®</sup> QAT Applications</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restart-sequence">Restart Sequence</a></li>
<li class="toctree-l4"><a class="reference internal" href="#status-of-packets-in-flight-crypto-applications-only">Status of Packets in Flight (Crypto Applications Only)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#determining-device-id">Determining Device ID</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-heartbeat">Testing Heartbeat</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-device-failures-in-a-virtualized-environment">Handling Device Failures in a Virtualized Environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#incorporating-dummy-responses-into-an-intel-qat-application">Incorporating Dummy Responses into an Intel<sup>®</sup> QAT Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_device_telemetry.html">Telemetry</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_ratelimiting.html">Rate Limiting</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_power_management.html">Power Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="infrastructure_ras.html">Reliability, Availability, and Stability (RAS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="acceleration_driver.html">Acceleration Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration_files_index.html">Configuration Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="services_index.html">Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="apis_index.html">Supported APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualization.html">Virtualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">Secure Architecture Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="revision_history.html">Revision History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../VIRT/index.html">Virtualization Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PERF/index.html">Performance Optimization Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qatlib/index.html">QATlib User’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AppNotes/index.html">Application Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_PG/index.html">API Programmer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/contact.html">Contact &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/collateral_list.html">Documentation &amp; Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel® QuickAssist Technology</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Programmer’s Guide</a> &raquo;</li>
          <li><a href="infrastructure_index.html">Infrastructure</a> &raquo;</li>
      <li>Heartbeat</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="heartbeat">
<span id="qat-2-0-pg-infrastructure-heartbeat"></span><h1>Heartbeat<a class="headerlink" href="#heartbeat" title="Permalink to this headline"></a></h1>
<p>Under some circumstances, firmware in the Intel<sup>®</sup> QAT devices could become unresponsive, requiring a device reset to recover. The Intel<sup>®</sup> QAT Heartbeat feature provides a mechanism for the customer application to detect and reset unresponsive devices. It also notifies the application processes of the start and end of the reset operation and suspends all Intel<sup>®</sup> QAT instances between the events.</p>
<section id="heartbeat-operation">
<h2>Heartbeat Operation<a class="headerlink" href="#heartbeat-operation" title="Permalink to this headline"></a></h2>
<p>A Heartbeat-enabled Intel<sup>®</sup> QAT device firmware periodically writes counters to a specified physical memory location. A pair of counters per thread is incremented at the start and end of the main processing loop within the firmware. Checking for Heartbeat consists of checking the validity of the pair of counter values for each thread. Stagnant counters indicate a firmware hang.</p>
<section id="initialization">
<h3>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline"></a></h3>
<p>At startup, the Intel<sup>®</sup> QAT device driver allocates memory for the counter pairs to be written by the firmware and then sends a message to the firmware to start the Heartbeat functionality.</p>
</section>
<section id="heartbeat-monitoring">
<h3>Heartbeat Monitoring<a class="headerlink" href="#heartbeat-monitoring" title="Permalink to this headline"></a></h3>
<p>Heartbeat check/monitoring refers to invocation of one of the two API calls that checks if the device is responsive. Heartbeat failure refers the API returning failure.</p>
<p>The Intel<sup>®</sup> QAT driver does not monitor for Heartbeat. It should be initiated by a Heartbeat management thread calling one of the following APIs periodically:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">icp_sal_check_device(Cpa32U</span> <span class="pre">accelId)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">icp_sal_check_all_devices(void)</span></code></p></li>
</ul>
</div></blockquote>
<p>A failure return code implies the device has failed or hung.</p>
<p>The Heartbeat management thread should satisfy the following conditions:</p>
<ul class="simple">
<li><p>For any given device, only one such process/thread should monitor.</p></li>
<li><p>One process can monitor one or more devices.</p></li>
<li><p>It can be a user application that uses Intel<sup>®</sup> QAT services, or a separate management/control plane process.</p></li>
<li><p>In virtualized environment, monitoring process(es)/thread(s) must run in the context of the host or hypervisor.</p></li>
</ul>
</section>
<section id="resetting-a-failed-device">
<h3>Resetting a Failed Device<a class="headerlink" href="#resetting-a-failed-device" title="Permalink to this headline"></a></h3>
<p>A device can be configured for automatic reset by the Intel<sup>®</sup> QAT framework or manually reset by the application by using the <code class="docutils literal notranslate"><span class="pre">AutoResetOnError</span></code> field in the device
configuration file <code class="docutils literal notranslate"><span class="pre">/etc/&lt;device&gt;.conf</span></code>, as shown below.</p>
<table class="longtable docutils align-default" id="id2">
<caption><span class="caption-text">AutoResetOnError Values</span><a class="headerlink" href="#id2" title="Permalink to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p><strong>AutoResetOnError Value</strong></p></th>
<th class="head"><p><strong>Action on Heartbeat Failure</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0 (default)</p></td>
<td><p>Do not reset the device</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Reset the device automatically</p></td>
</tr>
</tbody>
</table>
<p>If an Intel<sup>®</sup> QAT device is not configured for automatic reset, the management thread should reset it using the <code class="docutils literal notranslate"><span class="pre">icp_sal_reset_device(Cpa32U</span> <span class="pre">accelId)</span></code> API.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">icp_sal_reset_device()</span></code> function starts an asynchronous reset sequence and returns immediately. The reset function should not be called again until the device has completed the reset to avoid a reset storm. The <code class="docutils literal notranslate"><span class="pre">icp_sal_check_device(&lt;device</span> <span class="pre">id&gt;)</span></code> function could be called in a loop to check if the device reset is still in progress.</p>
<p>If the application devices are all configured for automatic reset then the <code class="docutils literal notranslate"><span class="pre">icp_sal_check_all_devices()</span></code> function could be used; otherwise, the function should not be used because it does not return the identity of the failed device, which is a required parameter for the <code class="docutils literal notranslate"><span class="pre">icp_sal_reset_device()</span></code> function.</p>
<section id="function-signatures">
<h4>Function Signatures<a class="headerlink" href="#function-signatures" title="Permalink to this headline"></a></h4>
<p>The details of the above functions, parameters, and return values can be found in <a class="reference internal" href="apis_additional_apis_index.html#qat-2-0-pg-supported-apis-additional-apis"><span class="std std-ref">Supported APIs &gt; Additional APIs</span></a>.</p>
</section>
</section>
</section>
<section id="incorporating-heartbeat-into-intel-qat-applications">
<h2>Incorporating Heartbeat into Intel<sup>®</sup> QAT Applications<a class="headerlink" href="#incorporating-heartbeat-into-intel-qat-applications" title="Permalink to this headline"></a></h2>
<p>A typical Intel<sup>®</sup> QAT user application consists of two tasks:</p>
<ul class="simple">
<li><p>The first task is typically an application thread that initializes Intel<sup>®</sup> QAT instances and sessions, and then submits service requests for Intel<sup>®</sup> QAT crypto or compression.</p></li>
<li><p>If an application employs polling to receive Intel<sup>®</sup> QAT service responses, then this task is also an application thread. Alternatively, responses are received as an interrupt handler.</p></li>
</ul>
<p>Two more tasks are required to support Heartbeat:</p>
<ul class="simple">
<li><p>The first is a management task to monitor the devices for failure or hang and then resets them, when required. As discussed earlier, this could be an application thread of an independent management process.</p></li>
<li><p>The second task is an application thread that polls for device reset events:</p>
<ul>
<li><p>Device is restarting: <code class="docutils literal notranslate"><span class="pre">CPA_INSTANCE_EVENT_RESTARTING</span></code></p></li>
<li><p>Device restart is complete: <code class="docutils literal notranslate"><span class="pre">CPA_INSTANCE_EVENT_RESTARTED</span></code></p></li>
</ul>
</li>
</ul>
<p>If the application employs polling to receive Intel<sup>®</sup> QAT
service responses, then this task could be included in the same polling
loop.</p>
<p>The polling for device events is done using the API: <code class="docutils literal notranslate"><span class="pre">icp_sal_poll_device_events()</span></code>.</p>
<p>The two callback functions for crypto and compression are registered
using the following APIs:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cpaCyInstanceSetNotificationCb</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpaDcInstanceSetNotificationCb</span></code></p></li>
</ul>
<p>The details of the above functions, parameters, and return values can be found in <a class="reference internal" href="apis_additional_apis_index.html#qat-2-0-pg-supported-apis-additional-apis"><span class="std std-ref">Supported APIs &gt; Additional APIs</span></a>.</p>
</section>
<section id="restart-sequence">
<h2>Restart Sequence<a class="headerlink" href="#restart-sequence" title="Permalink to this headline"></a></h2>
<p>During the restart sequence, the user space library releases the memory used for rings and other data structures as part of the shutdown and reallocates them when the restart is completed. This is transparent to the user application, so it can continue to use the same logical instance after reset to submit Intel<sup>®</sup> QAT service requests. Any memory allocated by the user application for the Intel<sup>®</sup> QAT service is untouched during device reset.</p>
<p>A typical Heartbeat error use-case is as follows:</p>
<ol class="arabic simple">
<li><p>The driver and the firmware is loaded, initialized and started.</p></li>
<li><p>The user-space application registers to receive instance notifications by calling <code class="docutils literal notranslate"><span class="pre">cpaCyInstanceSetNotificationCb</span></code> and <code class="docutils literal notranslate"><span class="pre">cpaDcInstanceSetNotificationCb</span></code>.</p></li>
<li><p>The management thread monitors for the device’s heartbeat. When a device is unresponsive, a device reset is initiated by this thread or by the Intel<sup>®</sup> QAT framework depending on the device configuration.</p></li>
<li><p>The kernel-space process sends the restarting event to the user-space process.</p></li>
<li><p>The user-space driver passes the device restarting event to all the registered application instances. It also frees memory and rings associated with the registered instances.</p></li>
<li><p>The kernel-space driver triggers the device reset.</p></li>
<li><p>During reset, the Intel<sup>®</sup> QAT service request made by the user application returns one of:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CPA_STATUS_FAIL</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CPA_STATUS_RETRY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CPA_STATUS_RESTARTING</span></code></p></li>
</ul>
</li>
<li><p>When the device reset is complete, the kernel-space driver sends a device restarted event to the user space driver.</p></li>
<li><p>The user space driver allocates the memory and rings and then forwards the device Restarted event to each of the registered instances.</p></li>
</ol>
</section>
<section id="status-of-packets-in-flight-crypto-applications-only">
<h2>Status of Packets in Flight (Crypto Applications Only)<a class="headerlink" href="#status-of-packets-in-flight-crypto-applications-only" title="Permalink to this headline"></a></h2>
<p>When a device has fatal errors, the application ordinarily cannot determine whether or not inflight requests have been processed successfully.</p>
<p>The current Intel<sup>®</sup> QAT release includes a dummy response feature that creates mock responses to all requests submitted during a fatal error condition, so the application can detect them and, therefore, know which requests need to be resubmitted to the available devices or to the software.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The sequence of dummy responses will match the sending request sequence for all requests submitted during a fatal error.</p>
</div>
<p>Since the dummy response feature only supports Public Key Encryption (PKE), dummy responses may be generated only when the <code class="docutils literal notranslate"><span class="pre">icp_sal_CyPollInstance()</span></code> function is called, since it is the function for crypto services.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">icp_sal_poll_device_events()</span></code> function should also be called by the application, so that the application get a notification when the device encounters a failure and dummy responses are generated when calling <code class="docutils literal notranslate"><span class="pre">icp_sal_CyPollInstance()</span></code> for the inflight requests.</p>
</section>
<section id="determining-device-id">
<h2>Determining Device ID<a class="headerlink" href="#determining-device-id" title="Permalink to this headline"></a></h2>
<p>The <em>&lt;device id&gt;</em> that is passed as a parameter to several Heartbeat API is the numeric suffix of the device name displayed by the following command. (device name: <em>qat_dev0</em>):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">service qat_service status</span>
</pre></div>
</div>
<p>The output will look like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>There is 1 QAT acceleration device(s) in the system: qat_dev0 - type: c3xxx, inst_id: 0, node_id: 0, bsf: 01:00.0, #accel: 3 #engines: 6 state: up
</pre></div>
</div>
<p>The Intel<sup>®</sup> QAT library has no API to discover the device number easily. However, an application can use the IOCTLs <code class="docutils literal notranslate"><span class="pre">IOCTL_GET_NUM_DEVICES</span></code>
and <code class="docutils literal notranslate"><span class="pre">IOCTL_STATUS_ACCEL_DEV</span></code> to find the device_id of a particular device if they know the Bus Device Function (BDF). Refer to <code class="docutils literal notranslate"><span class="pre">perform_query_dev()</span></code> in <code class="docutils literal notranslate"><span class="pre">./adf_ctl.cpp</span></code>.</p>
</section>
<section id="testing-heartbeat">
<h2>Testing Heartbeat<a class="headerlink" href="#testing-heartbeat" title="Permalink to this headline"></a></h2>
<p>Two debug capabilities are available to assist the developers incorporating Heartbeat into their applications:</p>
<ul class="simple">
<li><p>Simulation of Heartbeat failure.</p></li>
<li><p>System virtual files under <code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/</span></code>.</p></li>
</ul>
<section id="simulated-heartbeat-failure-configuration">
<h3>Simulated Heartbeat Failure Configuration<a class="headerlink" href="#simulated-heartbeat-failure-configuration" title="Permalink to this headline"></a></h3>
<p>The Heartbeat feature is always enabled in the package. However, a debug capability that simulates device failure can be enabled during the configure step as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">./configure --enable-icp-hb-fail-sim</span>
</pre></div>
</div>
</section>
<section id="simulating-heartbeat-failure">
<h3>Simulating Heartbeat Failure<a class="headerlink" href="#simulating-heartbeat-failure" title="Permalink to this headline"></a></h3>
<p>Simulating Heartbeat failure can be accomplished using two methods:</p>
<ul>
<li><p>Using the API <code class="docutils literal notranslate"><span class="pre">icp_sal_heartbeat_simulate_failure(&lt;device</span> <span class="pre">id&gt;)</span></code>.</p></li>
<li><p>Executing the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">cat /sys/kernel/debug/&lt;device&gt;/heartbeat_sim_fail</span>
</pre></div>
</div>
</li>
</ul>
<section id="system-virtual-files">
<span id="id1"></span><h4>System Virtual Files<a class="headerlink" href="#system-virtual-files" title="Permalink to this headline"></a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The heartbeat <code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug</span></code> files are associated with the QAT Physical Function (PF).</p>
</div>
<p>The Heartbeat feature implements the following system virtual files under the <code class="docutils literal notranslate"><span class="pre">/sys/kernel/debug/qat_&lt;device&gt;_&lt;your_device_BDF&gt;/</span></code> directory.</p>
<table class="longtable docutils align-default" id="id3">
<caption><span class="caption-text">Heartbeat System Virtual Files</span><a class="headerlink" href="#id3" title="Permalink to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p><strong>File</strong></p></th>
<th class="head"><p><strong>Content</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">heartbeat</span></code></p></td>
<td><p>0: Device is responsive. -1: Device is NOT responsive.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">heartbeat_failed</span></code></p></td>
<td><p>Number of times the device became unresponsive.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">heartbeat_sent</span></code></p></td>
<td><p>Number of times the control process checked if the device is responsive.</p></td>
</tr>
</tbody>
</table>
<p>A developer could simulate the Heartbeat management process by running the following script in the background:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="k">while</span> : <span class="k">do</span>
   cat /sys/kernel/debug/&lt;device&gt;/heartbeat &gt; /dev/null sleep <span class="m">1</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="heartbeat-polling-frequencies">
<h4>Heartbeat Polling Frequencies<a class="headerlink" href="#heartbeat-polling-frequencies" title="Permalink to this headline"></a></h4>
<p>The application developer should decide on the following two Heartbeat polling frequencies:</p>
<ul class="simple">
<li><p>Device Heartbeat monitoring.</p></li>
<li><p>Checking for device reset events.</p></li>
</ul>
<p><strong>Device Heartbeat Monitoring</strong></p>
<p>Consider the following points when determining the frequency of Heartbeat monitoring:</p>
<ul class="simple">
<li><p>Increasing Heartbeat monitoring frequency will minimize the customer’s system downtime.</p></li>
<li><p>However, since device unresponsiveness should be an infrequent event, high frequency Heartbeat monitoring wastes CPU cycles.</p></li>
<li><p>Also, if there are large Intel<sup>®</sup> QAT service requests that take some time to complete, high frequency Heartbeat monitoring could result in false reports of unresponsiveness.</p></li>
<li><p>With QAT Gen4 devices, heartbeat update timer in firmware is a constant value of 200ms (unconfigurable).  With QAT Gen2 devices this value is configurable with configuration item <strong>HeartbeatTimer</strong> (the default value is 500ms and the minimal allowed value is 200ms)</p></li>
<li><p>For both QAT Gen2 and Gen4 monitoring interval should be larger or equal than the Heartbeat update interval. (e.g. if user configure HeartbeatTimer=300, polling interval should be &gt;=300ms)</p></li>
</ul>
<p><strong>Checking for Device Reset Events</strong></p>
<p>If the application uses polling for reading Intel<sup>®</sup> QAT service responses, there is no value in checking for resets more frequently. Since device unresponsiveness is an infrequent occurrence, frequency of checking for reset events could be a fraction of the frequency of polling for Intel<sup>®</sup> QAT service responses.</p>
</section>
</section>
</section>
<section id="handling-device-failures-in-a-virtualized-environment">
<h2>Handling Device Failures in a Virtualized Environment<a class="headerlink" href="#handling-device-failures-in-a-virtualized-environment" title="Permalink to this headline"></a></h2>
<p>The Heartbeat feature in the acceleration software can be used in a virtualized environment. Refer to the <em>Using Intel®</em> <em>Virtualization Technology (Intel® VT) with</em> Intel<sup>®</sup> <em>QuickAssist Technology Application Note</em> for more details on enabling SR-IOV and the creation of Virtual Functions (VFs) from a single Intel<sup>®</sup> QuickAssist Technology acceleration device to support acceleration for multiple Virtual Machines (VMs).</p>
<p>The following sequence describes a possible use case for using the Heartbeat feature in a virtualized environment.</p>
<ol class="arabic simple">
<li><p>The Intel<sup>®</sup> QAT Physical Function driver (PF driver) isloaded, initialized and started.</p></li>
<li><p>The Intel<sup>®</sup> QAT Virtual Function driver (VF driver) is loaded, initialized and started in the Guest OS in the VM.</p></li>
<li><p>The PF driver detects that the firmware is unresponsive (using either of the following methods: User Proc Entry Read (not Enabled by Default) on page 47 or User Application Heartbeat APIs (not Enabled by Default) on page 48).</p></li>
<li><p>The PF driver sends the “Restarting” event message to the VF via the internal PFto-VF communication messaging mechanism.</p></li>
<li><p>The VF driver sends the “Restarting” event to the application’s registered callback. The callback is registered using either of the Intel<sup>®</sup> QAT API functions <code class="docutils literal notranslate"><span class="pre">cpaDcInstanceSetNotificationCb()</span></code> or <code class="docutils literal notranslate"><span class="pre">cpaCyInstanceSetNotificationCb()</span></code> in the Guest OS. (The application’s callback function may perform any application-level cleanup.)</p></li>
<li><p>The PF driver starts the reset sequence (save state, initiate reset, and restore state).</p></li>
<li><p>The user restarts the Guest OS and loads the VF driver and application in the Guest OS.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>If the Heartbeat feature in the acceleration software is not enabled, the PF driver will not notify the VF driver that the firmware is unresponsive.</p></li>
<li><p>The error detection mechanisms are not available on the VF driver in the VM, but device errors caused by any of the software running on the VM will be detected by the PF driver using the above mechanisms.</p></li>
</ul>
</div>
</section>
<section id="incorporating-dummy-responses-into-an-intel-qat-application">
<h2>Incorporating Dummy Responses into an Intel<sup>®</sup> QAT Application<a class="headerlink" href="#incorporating-dummy-responses-into-an-intel-qat-application" title="Permalink to this headline"></a></h2>
<p>The dummy response feature has been incorporated in a scenario with the Intel<sup>®</sup> QAT engine and Nginx*. Figure below illustrates how it works. This can be used as a reference to so-called “software fallback.”</p>
<p>The Intel<sup>®</sup> QAT engine is a shim layer between OpenSSL* libcrypto* and Intel<sup>®</sup> QAT Library. The Intel<sup>®</sup> QAT Library will generate failover responses.</p>
<p>The Heartbeat Monitoring Daemon, a single process, is a daemon which is used to check the device status periodically and trigger the driver the reset the device when heartbeat failure happens. Its only activity is calling <code class="docutils literal notranslate"><span class="pre">icp_sal_check_device()</span></code> or <code class="docutils literal notranslate"><span class="pre">icp_sal_check_all_devices()</span></code> periodically.</p>
<p>The Intel<sup>®</sup> QAT Engine polls for and handles “device error” and “device ok” events (via udev). It keeps track of the number of devices which are active.</p>
<ul class="simple">
<li><p>If some, but not all, Intel<sup>®</sup> QAT devices encounter errors, switch to remaining available devices by resubmitting the inflight requests, which are responded to with dummy responses and new requests to the available devices.</p></li>
<li><p>If the number of active Intel<sup>®</sup> QAT devices goes to zero, switch to software and resubmit the inflight requests which are responded to with dummy responses and new requests to the software.</p></li>
<li><p>If the number of active Intel<sup>®</sup> QAT devices goes positive again, switch back to hardware.</p></li>
</ul>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/Incorporating_Dummy_Responses_updated.png"><img alt="../_images/Incorporating_Dummy_Responses_updated.png" src="../_images/Incorporating_Dummy_Responses_updated.png" style="width: 710px; height: 508px;" /></a>
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="infrastructure_debugability.html" class="btn btn-neutral float-left" title="Debugability" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="infrastructure_device_telemetry.html" class="btn btn-neutral float-right" title="Telemetry" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Intel Corporation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>