<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Intel® QAT Cryptographic API &mdash; Intel® QuickAssist Technology  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/qat.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Intel® QAT Data Compression API" href="QAT_compressionAPI.html" />
    <link rel="prev" title="Base API and API Conventions" href="baseAPI.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Intel® QuickAssist Technology
          </a>
              <div class="version">
                Hardware Version 2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../qat_general/legal.html">Legal Notices &amp; Disclaimers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Intro/terminology.html">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/In-Tree/index.html">Release Notes - In-Tree</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/Linux/2.X/index.html">Release Notes - Linux*</a></li>
<li class="toctree-l1"><a class="reference internal" href="../RN/VMware/2.X/index.html">Release Notes - VMware*</a></li>
<li class="toctree-l1"><a class="reference internal" href="../GSG/2.X/index.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PG/index.html">Programmer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../VIRT/index.html">Virtualization Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PERF/index.html">Performance Optimization Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qatlib/index.html">QATlib User’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AppNotes/index.html">Application Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Programmer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="baseAPI.html">Base API and API Conventions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Intel® QAT Cryptographic API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sessions">Sessions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#priority">Priority</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-symmetric-cryptography-api">Using the Symmetric Cryptography API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#general-concepts">General Concepts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cipher">Cipher</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hash">Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hash-a-file">Hash a File</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash">Chained Cipher and Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash-ipsec-like-use-case">Chained Cipher and Hash – IPSec Like Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash-ssl-like-use-case">Chained Cipher and Hash – SSL Like Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash-ccm-use-case">Chained Cipher and Hash – CCM Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash-gcm-use-case">Chained Cipher and Hash – GCM Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#chained-cipher-and-hash-using-the-symmetric-data-plane-api">Chained Cipher and Hash Using the Symmetric Data Plane API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tls-key-and-mgf-mask-generation">TLS Key and MGF Mask Generation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#session-update-for-chained-cipher-and-hash-operation">Session Update for Chained Cipher and Hash Operation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hkdf-use-case">HKDF Use Case</a></li>
<li class="toctree-l4"><a class="reference internal" href="#perform-hkdf-operation">Perform HKDF Operation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-diffie-hellman-api">Using the Diffie-Hellman API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prime-number-testing">Prime Number Testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-sm2-api">Using the SM2 API</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sm2-digital-signature-generation-and-verification">SM2 Digital Signature Generation and Verification</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sm2-public-key-encryption">SM2 Public Key Encryption</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sm2-key-exchange">SM2 Key Exchange</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sm2-elliptic-curve-point">SM2 Elliptic Curve Point</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="QAT_compressionAPI.html">Intel® QAT Data Compression API</a></li>
<li class="toctree-l2"><a class="reference internal" href="revision_history.html">Revision History</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/contact.html">Contact &amp; Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../qat_general/collateral_list.html">Documentation &amp; Resources</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Intel® QuickAssist Technology</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">API Programmer’s Guide</a></li>
      <li class="breadcrumb-item active">Intel® QAT Cryptographic API</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="intel-qat-cryptographic-api">
<span id="qat-api-programmers-guide-qat-cryptoapi"></span><h1>Intel® QAT Cryptographic API<a class="headerlink" href="#intel-qat-cryptographic-api" title="Permalink to this heading"></a></h1>
<p>This section describes the sample code for the Intel® QuickAssist Technology
Cryptographic API, beginning with an API overview, and followed by descriptions of
various scenarios to illustrate the usage of the API.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>The Intel® QuickAssist Technology Cryptographic API can be categorized into the
following broad areas:</p>
<ul>
<li><p><strong>Common:</strong> This is defined by the file <code class="docutils literal notranslate"><span class="pre">cpa_cy_common.h</span></code>. This includes the
functionality for the initialization and shutdown of the service.</p></li>
<li><p><strong>Instance Management:</strong> The file <code class="docutils literal notranslate"><span class="pre">cpa_cy_im.h</span></code> defines the functions for managing
instances. A given implementation of the API can present multiple instances of the
cryptographic service, each representing a logical or virtual <em>device</em>. Request order
is guaranteed within a given instance of the service.</p></li>
<li><p><strong>Symmetric:</strong> The following files constitute the symmetric API:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_sym.h</span></code> file contains the symmetric API, used for ciphers,
hashing/message digests, <em>algorithm chaining</em> (combining cipher and hash
into a single call), and authenticated ciphers.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_sy_sym_dp.h</span></code> file also contains the symmetric API, used for ciphers,
hashing/message digest, <em>algorithm chaining</em> (combining cipher and hash into
a single call) and authenticated ciphers. This API is recommended for data
plane applications, in which the cost of offload (i.e. the cycles consumed by
the API in sending requests to the hardware and processing the responses)
needs to be minimized. Several constraints need to be acceptable to the
application. To use this API, these are listed in the
<a class="reference internal" href="baseAPI.html#qat-api-programmers-guide-baseapi-dataplaneapis"><span class="std std-ref">Data Plane APIs</span></a>
section.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_key.h</span></code> file contains the API for key generation for Secure Sockets
Layer (SSL) and Transport Layer Security (TLS).</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Asymmetric:</strong> The following files constitute the asymmetric API:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_rsa.h</span></code> file defines the API for RSA.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_dsa.h</span></code> file defines the API for Digital Signature Algorithm (DSA).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_dh.h</span></code> file defines the API for Diffie-Hellman.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_ec.h</span></code> file defines the API for <em>base</em> elliptic curve cryptography.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_ecdsa.h</span></code> file defines the API for Elliptic Diffie (EC) DSA.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_ecdh.h</span></code> file defines the API for Elliptic Diffie-Hellman (ECDH).</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_prime.h</span></code> file defines the API for prime number testing.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_ln.h</span></code> file defines the API for a large number of math operations, such as modular exponentiation, etc.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_ecsm2.h</span></code> file defines the API for SM2 algorithm which is based on Elliptic Curves Cryptography (ECC)</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Random Bit Generation (RBG):</strong> The following files constitute the RBG API and
have been deprecated because random bit generation can be handled in the CPU:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_drbg.h</span></code> file defines the API for deterministic random bit generation.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">cpa_cy_nrbg.h</span></code> file defines the API for a non-deterministic random bit generation.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>The cryptographic API uses the base API, which defines base data types used across
all services of the Intel® QAT API.</p>
<section id="sessions">
<h3>Sessions<a class="headerlink" href="#sessions" title="Permalink to this heading"></a></h3>
<p>The symmetric API is the only API with the concept of sessions. The meaning of a
session within the symmetric API is defined below.</p>
</section>
<section id="priority">
<h3>Priority<a class="headerlink" href="#priority" title="Permalink to this heading"></a></h3>
<p>The cryptographic symmetric API has support for priorities. Priority can be specified
on a per-session basis. Two levels of priority are supported: <em>high priority</em> and <em>normal priority</em>.
Implementations may use a strict priority order or a weighted round robinbased priority scheme.</p>
</section>
</section>
<section id="using-the-symmetric-cryptography-api">
<h2>Using the Symmetric Cryptography API<a class="headerlink" href="#using-the-symmetric-cryptography-api" title="Permalink to this heading"></a></h2>
<p>This section contains examples of how to use the symmetric API. It describes general
concepts and how to use the symmetric API to perform various types of cipher and
hash.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Examples are simplified and demonstrate how to use the APIs and build the structures required for various use cases.</p>
</div>
<p>These examples may not demonstrate the optimal way to use the API to get
maximum performance for a particular implementation. Refer to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for implementation specific documentation and performance sample code for a guide on
how to use the API for best performance.</p>
<p>All of the symmetric examples follow the same basic steps:</p>
<ul class="simple">
<li><p>Define a callback function (if the API is to be invoked asynchronously).</p></li>
<li><p>Discover and start up the cryptographic service instance.</p></li>
<li><p>Create and initialize a session.</p></li>
<li><p>Invoke multiple symmetric operations (cipher and/or hash) on the session.</p></li>
<li><p>Tear down the session.</p></li>
<li><p>Stop the cryptographic service instance.</p></li>
</ul>
<section id="general-concepts">
<h3>General Concepts<a class="headerlink" href="#general-concepts" title="Permalink to this heading"></a></h3>
<p>This section describes the following concepts:</p>
<ul class="simple">
<li><p><em>Session</em></p></li>
<li><p><em>Place and Out-of-Place Support</em></p></li>
<li><p><em>Partial Support</em></p></li>
</ul>
<section id="session">
<h4>Session<a class="headerlink" href="#session" title="Permalink to this heading"></a></h4>
<p>In case of the symmetric API, a session is a handle that describes the cryptographic
parameters to be applied to several buffers. This might be the buffers within a single
file or all the packets associated with a particular Internet Protocol Security (IPSec)
tunnel or security association. The data within a session handle includes the following:</p>
<ul>
<li><p>The operation (cipher, hash, or both, and if both, the order in which the algorithms
should be applied).</p></li>
<li><p>The cipher setup data, including the cipher algorithm and mode, the key and its
length, and the direction (encrypt or decrypt).</p></li>
<li><p>The hash setup data, including the hash algorithm, mode (plain, nested or
authenticated), and digest result length (to allow for truncation).</p>
<blockquote>
<div><ul class="simple">
<li><p>The authenticated mode can refer to Hashed Message Authenticate Code
(HMAC), which requires that the key and its length are also specified. It is also
used for Galois Counter Mode (GCM), and Counter mode with Cipher-block
Chaining Message authentication code (CCM) authenticated encryption, in
which case the Additional Authenticated Data (AAD) length is also specified.</p></li>
<li><p>For nested mode, the inner and outer prefix data and length are specified, as
well as the outer hash algorithm.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="in-place-and-out-of-place-support">
<h4>In-Place and Out-of-Place Support<a class="headerlink" href="#in-place-and-out-of-place-support" title="Permalink to this heading"></a></h4>
<p>An <em>In-Place</em> operation means that the destination buffer is the same as the source
buffer. An <em>Out-of-Place</em> operation means that the destination buffer is different from
the source buffer.</p>
</section>
<section id="partial-support">
<h4>Partial Support<a class="headerlink" href="#partial-support" title="Permalink to this heading"></a></h4>
<p>Most of the examples in this section operate on full packets, as indicated by the
<code class="docutils literal notranslate"><span class="pre">packetType</span></code> of <code class="docutils literal notranslate"><span class="pre">CPA_CY_SYM_PACKET_TYPE_FULL</span></code>. The API also supports operating in
partial mode, where, for example, state (e.g., cipher state) needs to be carried
forward from one packet/record to the next. In the <a class="reference internal" href="#qat-api-programmers-guide-qat-cryptoapi-hashafile"><span class="std std-ref">Hash a File</span></a> section,
there is an example of hashing a file that uses the partial API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The size of the data to be hashed or ciphered must be a multiple of the block size
of the algorithm for all partial packets.</p></li>
<li><p>For hash/authentication, the digest verify flag only applies to the last partial
packet.</p></li>
<li><p>For algorithm chaining, only the cipher state is maintained between calls. The
hash state is not maintained between calls; instead, the hash digest is
generated/verified for each call. The size of the data to be ciphered must be a
multiple of the block size of the algorithm for all partial packets. The size of the
data to be hashed does not have this restriction. If both the cipher state and the
hash state need to be maintained between calls, then algorithm chaining cannot
be used.</p></li>
</ul>
</div>
</section>
</section>
<section id="cipher">
<h3>Cipher<a class="headerlink" href="#cipher" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API, specifically using this API
to perform a cipher operation. It encrypts some sample text using the AES-256
algorithm in Cipher Block Chaining (CBC) mode.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">quickassist/lookaside/access_layer/src/sample_code/functional/sym/cipher_sample</span></code>.</p>
<p>The following subsections describe the main functions in this file.</p>
<section id="symcallback">
<h4>symCallback<a class="headerlink" href="#symcallback" title="Permalink to this heading"></a></h4>
<p>A callback function must be supplied to use the API in asynchronous mode, and this
function is called back (that is, invoked by the implementation of the API) when the
asynchronous operation has completed. The context in which it is invoked depends on
the implementation. For example, it could be invoked in the context of a Linux*
interrupt handler’s bottom half or in the context of a user created polling thread. The
context in which this function is invoked places restrictions on what processing can be
done in the callback function. On the API, it states that this function should not sleep
(since it may be called in a context that does not permit sleeping, for example, a
Linux* bottom half).</p>
<p>This function can perform whatever processing is appropriate for the application. For
example, it may free memory, continue the processing of a decrypted packet, etc. In
the below example, the function only sets the complete variable to indicate it has been
called.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">symCallback</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pCallbackTag</span><span class="p">,</span>
<span class="w">                        </span><span class="n">CpaStatus</span><span class="w"> </span><span class="n">status</span><span class="p">,</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">CpaCySymOp</span><span class="w"> </span><span class="n">operationType</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">pOpData</span><span class="p">,</span>
<span class="w">                        </span><span class="n">CpaBufferList</span><span class="w"> </span><span class="o">*</span><span class="n">pDstBuffer</span><span class="p">,</span>
<span class="w">                        </span><span class="n">CpaBoolean</span><span class="w"> </span><span class="n">verifyResult</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;Callback called with status = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pCallbackTag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Indicate that the function has been called */</span>
<span class="w">        </span><span class="n">COMPLETE</span><span class="p">((</span><span class="k">struct</span><span class="w"> </span><span class="nc">COMPLETION_STRUCT</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pCallbackTag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ciphersample">
<span id="qat-api-programmers-guide-qat-cryptoapi-ciphersample"></span><h4>cipherSample<a class="headerlink" href="#ciphersample" title="Permalink to this heading"></a></h4>
<p>This is the main entry point for the sample cipher code. It demonstrates the sequence
of calls to be made to the API to create a session, perform one or more cipher
operations, and then tear down the session.</p>
<p>First, call the instance discovery utility function - <code class="docutils literal notranslate"><span class="pre">sampleCyGetInstance</span></code> - which is a
simplified version of instance discovery, in which exactly one instance of a crypto
service is discovered. It does this by querying the API for all instances, and
returning the first instance, as illustrated in the below example.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This step is described in the <a class="reference internal" href="baseAPI.html#qat-api-programmers-guide-baseapi-instancediscovery"><span class="std std-ref">Instance Discovery</span></a> section,
but is repeated here for convenience.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef DO_CRYPTO</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">sampleCyGetInstance</span><span class="p">(</span><span class="n">CpaInstanceHandle</span><span class="o">*</span><span class="w"> </span><span class="n">pCyInstHandle</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CpaInstanceHandle</span><span class="w"> </span><span class="n">cyInstHandles</span><span class="p">[</span><span class="n">MAX_INSTANCES</span><span class="p">];</span>
<span class="w">    </span><span class="n">Cpa16U</span><span class="w"> </span><span class="n">numInstances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">CpaStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_STATUS_SUCCESS</span><span class="p">;</span>

<span class="w">    </span><span class="o">*</span><span class="n">pCyInstHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyGetNumInstances</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numInstances</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CPA_STATUS_SUCCESS</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">numInstances</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyGetInstances</span><span class="p">(</span><span class="n">MAX_INSTANCES</span><span class="p">,</span><span class="w"> </span><span class="n">cyInstHandles</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CPA_STATUS_SUCCESS</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">pCyInstHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyInstHandles</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">numInstances</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;No instances found for &#39;SSL&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;Please check your section names in the config file.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;Also make sure to use config file version 2.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>The below example sets the address translation function for the instance. This function will be used by the
API to convert virtual addresses to physical addresses.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySetAddressTranslation</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">);</span>
</pre></div>
</div>
<p>Start the crypto service running as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyStartInstance</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">);</span>
</pre></div>
</div>
<p>The next step is to create and initialize a session. First, populate the fields of the
session initialization operational data structure.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The size required to store a session is implementation-dependent, so you must query
the API first to determine how much memory to allocate, and then allocate that memory.</p>
</div>
<p>One of two available queries can be used:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">cpaCySymSessionCtxGetSize(const</span> <span class="pre">CpaInstanceHandle</span> <span class="pre">instanceHandle_in,</span> <span class="pre">const</span> <span class="pre">CpaCySymSessionSetupData</span> <span class="pre">*pSessionSetupData,</span> <span class="pre">Cpa32U</span> <span class="pre">*pSessionCtxSizeInBytes)</span></code></p>
<blockquote>
<div><ul class="simple">
<li><p>This will always return the maximum session context size (i.e., the full size of the
session including padding and other session state information). See example below.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpaCySymSessionCtxGetDynamicSize(const</span> <span class="pre">CpaInstanceHandle</span> <span class="pre">instanceHandle_in,</span> <span class="pre">const</span> <span class="pre">CpaCySymSessionSetupData</span> <span class="pre">*pSessionSetupData,</span> <span class="pre">Cpa32U</span> <span class="pre">*pSessionCtxSizeInBytes)</span></code></p>
<blockquote>
<div><ul>
<li><p>This query can be used instead to return a reduced memory size, based on whether
the use case meets certain session setup criteria. See example below.</p></li>
<li><p>This query will return one of three values for <code class="docutils literal notranslate"><span class="pre">pSessionCtxSizeInBytes</span></code> as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>If partial packets are not being used and the symmetric operation is <em>AuthEncrypt</em> (i.e., the cipher and hash algorithms are either CCM or GCM), the size
returned will be approximately half of the standard size.</p></li>
<li><p>If partial packets are not being used and the cipher algorithm is not <em>ARC4</em>,
<em>Snow3g_UEA2</em>, <em>AES_CCM</em> or <em>AES_GCM</em>, and the hash algorithm is not
<em>Snow3G_UIA2</em>, <em>AES_CCM</em> or <em>AES_GCM</em>, and Hash Mode is not <em>Auth</em>, the size
returned will be between half and one third of the standard size.</p></li>
<li><p>In all other cases, the standard size is returned.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<p>The following parameter exists in the <code class="docutils literal notranslate"><span class="pre">CpaCySymSessionSetupData</span></code> structure:
<code class="docutils literal notranslate"><span class="pre">CpaBoolean</span> <span class="pre">partialsNotRequired</span></code></p>
<p>This flag indicates if partial packet processing is required for the session. If partial
packets are not being used and the preference is to use one of the reduced session
memory sizes, set this flag to <code class="docutils literal notranslate"><span class="pre">CPA_TRUE</span></code> before calling the
<code class="docutils literal notranslate"><span class="pre">cpaCySymSessionCtxGetDynamicSize()</span></code> function.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The equivalent reduced memory context query for Data Plane API is:
<code class="docutils literal notranslate"><span class="pre">cpaCySymDpSessionCtxGetDynamicSize(const</span> <span class="pre">CpaInstanceHandle</span> <span class="pre">instanceHandle_in,</span> <span class="pre">const</span> <span class="pre">CpaCySymSessionSetupData</span> <span class="pre">*pSessionSetupData,</span> <span class="pre">Cpa32U</span> <span class="pre">*pSessionCtxSizeInBytes)</span></code>.
Refer to section
<a class="reference internal" href="#qat-api-programmers-guide-qat-cryptoapi-chainedcipherhashsymdataplaneapi"><span class="std std-ref">Chained Cipher and Hash Using the Symmetric Data Plane API</span></a>)
for more details.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate the session setup structure for the operation required */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_NORMAL</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_CIPHER</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="cm">/* Determine size of session context to allocate */</span>
<span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymSessionCtxGetSize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymSessionCtxGetSize</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionCtxSize</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Allocate session context */</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sessionCtx</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtxSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize the Cipher session */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymInitSession</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymInitSession</span><span class="p">(</span>
<span class="w">        </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">        </span><span class="n">symCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Callback function */</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Session setup data */</span>
<span class="w">        </span><span class="n">sessionCtx</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Output of the function */</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The next step is to call the function <code class="docutils literal notranslate"><span class="pre">cipherPerformOp</span></code>, which actually performs the cipher operation.
This in turn performs the following steps:</p>
<ul>
<li><p><strong>Memory Allocation:</strong> Different implementations of the API require different
amounts of space to store metadata associated with buffer lists. Query the API to
find out how much space the current implementation needs, and then allocate space
for the buffer metadata, the buffer list, and for the buffer itself. You must also
allocate memory for the initialization vector. See below example. The memory for
the source buffer and initialization vector is populated with the required data.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyBufferListGetMetaSize</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">numBuffers</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">bufferMetaSize</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBufferMeta</span><span class="p">,</span><span class="w"> </span><span class="n">bufferMetaSize</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pBufferList</span><span class="p">,</span><span class="w"> </span><span class="n">bufferListMemSize</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pSrcBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pIvBuffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>Set Up Operational Data:</strong> Populate the structure containing the operational data
that is needed to run the algorithm as shown below.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherSrc</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>Perform Operation:</strong> Initialize the completion variable, which is used by the
callback function to indicate that the operation is complete, then perform the
operation. See below example.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">COMPLETION_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymPerformOp</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Data sent as is to the callback function*/</span>
<span class="w">    </span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Operational data struct */</span>
<span class="w">    </span><span class="n">pBufferList</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Source buffer list */</span>
<span class="w">    </span><span class="n">pBufferList</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Same src &amp; dst for an in-place operation*/</span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><strong>Wait for Completion:</strong> Because the asynchronous API is used in this example, the
callback function must be handled. The below example uses a macro that can be defined
differently for different operating systems. In a typical real-world application, the
calling thread would not block, and the callback would essentially re-inject the
(decrypted, decapsulated) packet into the stack.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">COMPLETION_WAIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="n">TIMEOUT_MS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;timeout or interruption in cpaCySymPerformOp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_STATUS_FAIL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In a normal usage scenario, the session would be reused multiple times to encrypt
multiple buffers or packets. In this example, however, the session is torn down.</p>
</div>
<p>Since cryptographic API v2.2, before removing the symmetric session context it is
recommended to wait for the completion of any outstanding request using
<code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>. It is executed in the <code class="docutils literal notranslate"><span class="pre">symSessionWaitForInflightReq</span></code> call
which polls for the in-flight requests.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">symSessionWaitForInflightReq</span><span class="p">(</span><span class="n">sessionCtx</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, clean up by freeing up memory, stopping the instance, etc. See below example.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymRemoveSession</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">);</span>
</pre></div>
</div>
<p>Query statistics at this point, which can be useful for debugging. Some implementations may also make the
statistics available through other mechanisms, such as the <code class="docutils literal notranslate"><span class="pre">/proc</span></code> virtual filesystem.</p>
<p>Since cryptographic API v2.2, two new functions have been implemented:
<code class="docutils literal notranslate"><span class="pre">cpaCySymUpdateSession</span></code> and <code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>.</p>
<ul class="simple">
<li><p>The function <code class="docutils literal notranslate"><span class="pre">cpaCySymUpdateSession</span></code> can be used to update certain parameters of
a session like the cipher key, the cipher direction, and the authentication key.
<code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code> indicates whether there are outstanding requests on a
given session.</p></li>
<li><p>As a result of the implementation of this feature, the behavior of
<code class="docutils literal notranslate"><span class="pre">cpaCySymRemoveSession</span></code> has been changed. <code class="docutils literal notranslate"><span class="pre">cpaCySymRemoveSession</span></code> will fail if
there are outstanding request for the session that the user is trying to remove.
As a result, it is recommended to wait for the completion of any outstanding request,
using <code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>, before removing a session.</p></li>
</ul>
</section>
</section>
<section id="hash">
<h3>Hash<a class="headerlink" href="#hash" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API, specifically using this API
to perform a hash operation. It performs a SHA-256 hash operation on some sample
data.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/hash_sample</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This hash example is very similar to the cipher example, so only the differences are highlighted.</p>
</div>
<p>When creating and initializing a session, some of the fields of the session initialization
operational data structure are different from the cipher case, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate symmetric session data structure for a plain hash operation */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_NORMAL</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_HASH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA256</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_PLAIN</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="cm">/* Place the digest result in a buffer unrelated to srcBuffer */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
<span class="cm">/* Generate the digest */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the hash operation, some of the fields of the
operational data structure are again different from the cipher case, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">vectorData</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pDigestResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pDigestBuffer</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="hash-a-file">
<span id="qat-api-programmers-guide-qat-cryptoapi-hashafile"></span><h3>Hash a File<a class="headerlink" href="#hash-a-file" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API for partial mode,
specifically using this API to perform hash operations. It performs a SHA-1 hash
operation on a file.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/hash_file_sample</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This hash example is very similar to the cipher example, so only the differences are highlighted.</p>
</div>
<p>When creating and initializing a session, some of the fields of the session initialization
operational data structure are different from the cipher case, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate symmetric session data structure for a plain hash operation */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_NORMAL</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_HASH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA1</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_PLAIN</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="cm">/* Place the digest result in a buffer unrelated to srcBuffer */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
<span class="cm">/* Generate the digest */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>Memory is allocated for the source buffer in a similar way to the cipher case.</p>
<p>To perform the operation, data is read from the file to the source buffer and the
symmetric API is called repeatedly with <code class="docutils literal notranslate"><span class="pre">packetType</span></code> set to
<code class="docutils literal notranslate"><span class="pre">CPA_CY_SYM_PACKET_TYPE_PARTIAL</span></code>. When the end of the file is reached the API is
called with <code class="docutils literal notranslate"><span class="pre">packetType</span></code> set to <code class="docutils literal notranslate"><span class="pre">CPA_CY_SYM_PACKET_TYPE_PARTIAL_LAST</span></code>. The digest
is produced only on the last call to the API. See example below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">feof</span><span class="p">(</span><span class="n">srcFile</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* Read from file into src buffer */</span>
<span class="w">    </span><span class="n">pBufferList</span><span class="o">-&gt;</span><span class="n">pBuffers</span><span class="o">-&gt;</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fread</span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">SAMPLE_BUFF_SIZE</span><span class="p">,</span><span class="w"> </span><span class="n">srcFile</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* If we have reached the end of file set the last partial flag */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">feof</span><span class="p">(</span><span class="n">srcFile</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_LAST_PARTIAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_PARTIAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="w">    </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pBufferList</span><span class="o">-&gt;</span><span class="n">pBuffers</span><span class="o">-&gt;</span><span class="n">dataLenInBytes</span><span class="p">;</span>
<span class="w">    </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pDigestResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pDigestBuffer</span><span class="p">;</span>

<span class="w">    </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymPerformOp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* Perform symmetric operation */</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymPerformOp</span><span class="p">(</span>
<span class="w">        </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Data sent as is to the callback function */</span>
<span class="w">        </span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Operational data struct */</span>
<span class="w">        </span><span class="n">pBufferList</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Source buffer list */</span>
<span class="w">        </span><span class="n">pBufferList</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Same src &amp; dst for an in-place operation */</span>
<span class="w">        </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;cpaCySymPerformOp failed. (status = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Wait until the completion of the operation */</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">COMPLETION_WAIT</span><span class="p">((</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">),</span><span class="w"> </span><span class="n">TIMEOUT_MS</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PRINT_ERR</span><span class="p">(</span><span class="s">&quot;timeout or interruption in cpaCySymPerformOp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_STATUS_FAIL</span><span class="p">;</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="chained-cipher-and-hash">
<h3>Chained Cipher and Hash<a class="headerlink" href="#chained-cipher-and-hash" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API, specifically using this API
to perform a <em>chained</em> cipher and hash operation. It encrypts some sample text using
the AES-256 algorithm in CBC mode, and then performs a SHA-256 Hashed Message
Authenticate Code (HMAC) operation on the ciphertext, writing the Message
Authentication Code (MAC) to the buffer immediately after the ciphertext.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/alg_chaining_sample</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This chained example is very similar to the cipher and hash examples, so only the differences are highlighted.</p>
</div>
<p>When creating and initializing a session, some of the fields of the session initialization
operational data structure are different, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA256</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>

<span class="cm">/* The resulting MAC is to be placed immediately after the ciphertext */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the chained cipher and hash operation, some of
the fields of the operational data structure are again different from the cipher case, as
shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate the structure containing the operational data that is</span>
<span class="cm"> * needed to run the algorithm */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAlgChainingSrc</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAlgChainingSrc</span><span class="p">);</span>
</pre></div>
</div>
<p>Notice the <code class="docutils literal notranslate"><span class="pre">digestIsAppended</span></code> is set in the session; therefore, the MAC is placed
immediately after the region to hash, and the <code class="docutils literal notranslate"><span class="pre">pDigestResult</span></code> parameter of the
operational data is ignored.</p>
</section>
<section id="chained-cipher-and-hash-ipsec-like-use-case">
<h3>Chained Cipher and Hash – IPSec Like Use Case<a class="headerlink" href="#chained-cipher-and-hash-ipsec-like-use-case" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API for IPSec-like use cases,
as described in the below figures. For the outbound direction, this example uses
the symmetric API to perform a <em>chained</em> cipher and hash operation. It encrypts some
plaintext using the Advanced Encryption Standard (AES) algorithm in CBC mode, and
then performs a SHA1 HMAC operation on the ciphertext, initialization vector, and
header, writing the Integrity Check Value (ICV) to the buffer immediately after the
ciphertext. For the inbound direction, this example again uses the symmetric API to
perform a <em>chained</em> hash and cipher operation. It performs a SHA1 HMAC operation
on the ciphertext, initialization vector, and header and compares the result with the
input ICV. Then it decrypts the ciphertext using the AES algorithm in CBC mode.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/IPSec_Outbound.png"><img alt="../_images/IPSec_Outbound.png" src="../_images/IPSec_Outbound.png" style="width: 380px; height: 437px;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/IPSec_Inbound.png"><img alt="../_images/IPSec_Inbound.png" src="../_images/IPSec_Inbound.png" style="width: 380px; height: 389px;" /></a>
</figure>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/ipsec_sample</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This chained example is very similar to the cipher and hash examples, so only the differences are highlighted.</p>
</div>
<p>When creating and initializing a session in the <em>outbound</em> direction, the session
initialization operational data structure is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA1</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICV_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleAuthKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAuthKey</span><span class="p">);</span>

<span class="cm">/* Even though ICV follows immediately after the region to hash</span>
<span class="cm"> * digestIsAppended is set to false in this case to workaround</span>
<span class="cm"> * errata number IXA00378322 */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
<span class="cm">/* Generate the ICV in outbound direction */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the chained cipher and hash operation, the fields
of the operational data structure are shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate the structure containing the operational data that is</span>
<span class="cm"> * needed to run the algorithm in outbound direction */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleEspHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleEspHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">);</span>
<span class="cm">/* Even though ICV follows immediately after the region to hash</span>
<span class="cm"> * digestIsAppended is set to false in this case to workaround</span>
<span class="cm"> * errata number IXA00378322 */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pDigestResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSrcBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleEspHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">));</span>
</pre></div>
</div>
<p>In this example <code class="docutils literal notranslate"><span class="pre">samplePayload</span></code> is the packet data plus the Encapsulating Security
Payload (ESP) trailer.</p>
<p>When creating and initializing a session in the <em>inbound</em> direction, the session
initialization operational data structure is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_DECRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA1</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ICV_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleAuthKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAuthKey</span><span class="p">);</span>

<span class="cm">/* ICV follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* Verify the ICV in the inbound direction */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the chained hash and cipher operation, the fields
of the operational data structure are listed below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Populate the structure containing the operational data that is</span>
<span class="cm"> * needed to run the algorithm in inbound direction */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleEspHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleEspHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ICV_LENGTH</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ICV_LENGTH</span><span class="p">;</span>
</pre></div>
</div>
<p>In the example above, <code class="docutils literal notranslate"><span class="pre">bufferSize</span></code> is the size of the data input (header, iv, ciphertext,
and ICV).</p>
</section>
<section id="chained-cipher-and-hash-ssl-like-use-case">
<h3>Chained Cipher and Hash – SSL Like Use Case<a class="headerlink" href="#chained-cipher-and-hash-ssl-like-use-case" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API for SSL-like use cases, as
described in the below figures. For the outbound direction, this example employs
the symmetric API to perform a <em>chained</em> hash and cipher operation. It performs a
SHA1 HMAC2 operation on a sequence number, part of the header, and the plaintext.</p>
<p>The resultant MAC is placed immediately after the plaintext. Then it encrypts the
plaintext, MAC, and padding using the AES algorithm in CBC mode.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Not all SSL use cases use HMAC. For example, the Secure Sockets Layer (SSL)
Protocol Version 3.0 (SSLv3) (RFC 6106) does not use HMAC (in this case the nested
hash functionality on the API can be used). However, the Transport Layer Security
(TLS) Protocol (TLS V1.2), for example, does use the HMAC algorithm.</p>
</div>
<p>For the inbound direction, this example again employs the use of the symmetric API to
perform a <em>chained</em> cipher and hash operation. It decrypts the ciphertext using the
AES algorithm in CBC mode. Then it performs a SHA1 HMAC operation on the
resultant plaintext, sequence number, and part of the header and compares the
result with the input MAC.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the inbound direction to use the <em>chained</em> API, the length of the plaintext needs to
be known before the ciphertext is decrypted to set <code class="docutils literal notranslate"><span class="pre">messageLenToHashInBytes</span></code> and the length
field in the header correctly.</p>
</div>
<p>For stream ciphers (e.g., ARC4), there is no padding added in the outbound direction,
so the length of the plaintext is simply the length of the ciphertext minus the length of
the MAC. However, for block ciphers in CBC mode (as used in this example), the
<code class="docutils literal notranslate"><span class="pre">padlen</span></code> is required to calculate the plaintext length. The final block of the ciphertext
needs to be decrypted to discover the <code class="docutils literal notranslate"><span class="pre">padlen</span></code>. In this example, before calling the
<em>chained</em> API, the final block of the ciphertext is decrypted to discover the <code class="docutils literal notranslate"><span class="pre">padlen</span></code>.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/SSL_Outbound.png"><img alt="../_images/SSL_Outbound.png" src="../_images/SSL_Outbound.png" style="width: 385px; height: 437px;" /></a>
</figure>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/SSL_Inbound.png"><img alt="../_images/SSL_Inbound.png" src="../_images/SSL_Inbound.png" style="width: 474px; height: 389px;" /></a>
</figure>
<p>If using a block cipher in CBC mode, then the last ciphertext block is used as the IV
for subsequent packets (or records) in Secure Sockets Layer (SSL) and TLSv1.0,
whereas in TLSv1.1 and 1.2 an explicit IV is used. However, if using a stream cipher
that does not use a synchronization vector (such as ARC4), the stream cipher state
from the end of one packet is used to process the subsequent packets. If using the QA
API in this case, then partial mode should be used to ensure the stream cipher state is
maintained across multiple calls to the API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This chained example is very similar to the cipher and hash examples, so only the differences are highlighted.</p>
</div>
<p>When creating and initializing a session in the <em>outbound</em> direction, the session setup
data structure is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA1</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleAuthKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAuthKey</span><span class="p">);</span>

<span class="cm">/* MAC follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* Generate the MAC in outbound direction */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>A buffer large enough to hold the plaintext, MAC and padding is required. The size of
this buffer will be the one shown in the below example.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="p">;</span>

<span class="cm">/* bufferSize needs to be rounded up to a multiple of the AES block size */</span>
<span class="n">padLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="n">bufferSize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">padLen</span><span class="p">;</span>
<span class="cm">/* padLen excludes pad_length field */</span>
<span class="n">padLen</span><span class="o">--</span><span class="p">;</span>
</pre></div>
</div>
<p>This buffer is filled with plaintext and padding leaving room for the <em>chained</em> API
operation to add the MAC, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">memcpy</span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">samplePayload</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">));</span>
<span class="cm">/* Leave space for MAC but insert padding data */</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">padLen</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pSrcBuffer</span><span class="p">[(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">padLen</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The session sequence number, the header and the buffer with the plaintext are
described using a <code class="docutils literal notranslate"><span class="pre">CpaBufferList</span></code>, as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pBufferList</span><span class="o">-&gt;</span><span class="n">pBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pFlatBuffer</span><span class="p">;</span>
<span class="n">pBufferList</span><span class="o">-&gt;</span><span class="n">numBuffers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numBuffers</span><span class="p">;</span>
<span class="n">pBufferList</span><span class="o">-&gt;</span><span class="n">pPrivateMetaData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pBufferMeta</span><span class="p">;</span>

<span class="cm">/* Seq number */</span>
<span class="n">pFlatBuffer</span><span class="o">-&gt;</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CombinedHeadSize</span><span class="p">;</span>
<span class="n">pFlatBuffer</span><span class="o">-&gt;</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCombinedHeadBuffer</span><span class="p">;</span>
<span class="n">pFlatBuffer</span><span class="o">++</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pCombinedHeadBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SESSION_SEQ_START</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessSeqNum</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sessSeqNum</span><span class="p">));</span>
<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">pCombinedHeadBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HDR_START</span><span class="p">,</span><span class="w"> </span><span class="n">sampleHdrData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleHdrData</span><span class="p">));</span>

<span class="cm">/* Data */</span>
<span class="n">pFlatBuffer</span><span class="o">-&gt;</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">;</span>
<span class="n">pFlatBuffer</span><span class="o">-&gt;</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pSrcBuffer</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the chained hash and cipher operation, the fields
of the operational data structure are shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CombinedHeadSize</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SESSION_SEQ_START</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sessSeqNum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">padLen</span><span class="p">;</span>
</pre></div>
</div>
<p>When creating and initializing a session in the <em>inbound</em> direction, the session setup
data structure is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA1</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleAuthKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAuthKey</span><span class="p">);</span>

<span class="cm">/* MAC follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* Generate the MAC in outbound direction */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
</pre></div>
</div>
<p>In this case the length of the ciphertext is <code class="docutils literal notranslate"><span class="pre">bufferSize</span></code> to calculate the <code class="docutils literal notranslate"><span class="pre">padLen</span></code> the
final block is decrypted. See example below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">Cpa8U</span><span class="w"> </span><span class="n">resBuff</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cm">/* For decrypt direction need to decrypt the final block</span>
<span class="cm"> * to determine the messageLenToHashInBytes */</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCodeAesCbcDecrypt</span><span class="p">(</span>
<span class="w">  </span><span class="n">sampleCipherKey</span><span class="p">,</span>
<span class="w">  </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">),</span>
<span class="w">  </span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">)),</span><span class="w"> </span><span class="cm">/* IV */</span>
<span class="w">  </span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">16</span><span class="p">)),</span><span class="w"> </span><span class="cm">/* src */</span>
<span class="w">  </span><span class="n">resBuff</span><span class="p">);</span><span class="w"> </span><span class="cm">/* dest */</span>

<span class="cm">/* padLen is the last byte decrypted incremented by one to</span>
<span class="cm"> * included the padLen block itself */</span>
<span class="n">padLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resBuff</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</pre></div>
</div>
<p>When calling the function to perform the chained cipher and hash operation, the fields
of the operational data structure are shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CombinedHeadSize</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SESSION_SEQ_START</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sessSeqNum</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleHdrData</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">MAC_LENGTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">padLen</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="chained-cipher-and-hash-ccm-use-case">
<h3>Chained Cipher and Hash – CCM Use Case<a class="headerlink" href="#chained-cipher-and-hash-ccm-use-case" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API to perform a CCM
operation as described in NIST publication SP800-38C (<em>Recommendation for Block
Cipher Modes of Operation: The CCM Mode for Authentication and Confidentiality</em>). Refer
to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a> for more information.</p>
<p>This sample is located in <code class="docutils literal notranslate"><span class="pre">/sym/ccm_sample</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This chained example is very similar to the cipher and hash examples, so only the differences are highlighted.</p>
</div>
<p>For the generation-encryption process the session setup data is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_AES_CCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>

<span class="cm">/* Notice for CCM authKey and authKeyLen are not required this</span>
<span class="cm"> * information is provided by the cipherKey in cipherSetupData */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAssocData</span><span class="p">);</span>
<span class="cm">/* For CCM digestAppended and digestVerify are not required. In</span>
<span class="cm"> * the encrypt direction digestAppended is CPA_TRUE and</span>
<span class="cm"> * digestVerify is CPA_FALSE */</span>
</pre></div>
</div>
<p>For the decryption-verification process the session setup data is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_DECRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_AES_CCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAssocData</span><span class="p">);</span>
</pre></div>
</div>
<p>The IV and AAD buffers are allocated as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Allocate memory to store IV. For CCM this is the counter block</span>
<span class="cm"> * ctr0 (size equal to AES block size). The implementation will</span>
<span class="cm"> * construct the ctr0 block given the nonce. Space for ctr0 must be</span>
<span class="cm"> * allocated here */</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pIvBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Allocate memory for AAD. For CCM this memory will hold the 16 byte</span>
<span class="cm">   * B0 block, the 2 bytes encoded length of associated data, the</span>
<span class="cm">   * assocaiated data itself and any padding to ensure total size is</span>
<span class="cm">   * a multiple of the AES block size */</span>
<span class="w">  </span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B0_BLOCK_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALEN_ENCODING_SIZE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAssocData</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pAadBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">aadBuffSize</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The operational data needed to perform the generate-encrypt or decrypt-verify
operation is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="cm">/* Even though the iv buffer is 16 bytes the ivLenInBytes</span>
<span class="cm"> * is set to the length of the nonce. For CCM valid lengths</span>
<span class="cm"> * are in the range 7-13 */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleNonce</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">);</span>
<span class="cm">/* Notice for CCM hash offset and length are not required */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pAdditionalAuthData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pAadBuffer</span><span class="p">;</span>

<span class="cm">/* Populate pIv and pAdditionalAuthData buffers with</span>
<span class="cm"> * nonce and assoc data */</span>
<span class="n">CPA_CY_SYM_CCM_SET_NONCE</span><span class="p">(</span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="n">sampleNonce</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleNonce</span><span class="p">));</span>
<span class="n">CPA_CY_SYM_CCM_SET_AAD</span><span class="p">(</span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="n">sampleAssocData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAssocData</span><span class="p">));</span>
</pre></div>
</div>
</section>
<section id="chained-cipher-and-hash-gcm-use-case">
<h3>Chained Cipher and Hash – GCM Use Case<a class="headerlink" href="#chained-cipher-and-hash-gcm-use-case" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the symmetric API to perform a GCM
operation as described in NIST publication SP800-38D (<em>Recommendation for Block
Cipher Modes of Operation: Galois/Counter Mode (GCM) and GMAC</em>). Refer
to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a> for more information.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/gcm_sample</span></code>.</p>
<p>An example of the session setup data and operational data for GCM authenticated
encryption and decryption is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAG_LENGTH</span><span class="p">;</span>

<span class="cm">/* For GCM authKey and authKeyLen are not required this information</span>
<span class="cm"> * is provided by the cipherKey in cipherSetupData */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAddAuthData</span><span class="p">);</span>
<span class="cm">/* Tag follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* digestVerify is not required to be set. For GCM authenticated</span>
<span class="cm"> * encryption this value is understood to be CPA_FALSE */</span>
</pre></div>
</div>
<p>For authenticated encryption the session setup data is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_DECRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAG_LENGTH</span><span class="p">;</span>

<span class="cm">/* For GCM authKey and authKeyLen are not required this information</span>
<span class="cm"> * is provided by the cipherKey in cipherSetupData */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAddAuthData</span><span class="p">);</span>
<span class="cm">/* Tag follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* digestVerify is not required to be set. For GCM authenticated</span>
<span class="cm"> * decryption this value is understood to be CPA_TRUE */</span>
</pre></div>
</div>
<p>For authenticated decryption the session setup data is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_DECRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_AES_GCM</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TAG_LENGTH</span><span class="p">;</span>

<span class="cm">/* For GCM authKey and authKeyLen are not required this information</span>
<span class="cm"> * is provided by the cipherKey in cipherSetupData */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAddAuthData</span><span class="p">);</span>
<span class="cm">/* Tag follows immediately after the region to hash */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="cm">/* digestVerify is not required to be set. For GCM authenticated</span>
<span class="cm"> * decryption this value is understood to be CPA_TRUE */</span>
</pre></div>
</div>
<p>The IV and AAD buffers are allocated as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Allocate memory to store IV. For GCM this is the block J0</span>
<span class="cm"> * (size equal to AES block size). If iv is 12 bytes the</span>
<span class="cm"> * implementation will construct the J0 block given the iv.</span>
<span class="cm"> * If iv is not 12 bytes then the user must construct the J0</span>
<span class="cm"> * block and give this as the iv. In both cases space for J0</span>
<span class="cm"> * must be allocated. */</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pIvBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Allocate memory for AAD. For GCM this memory will hold the</span>
<span class="cm">   * additional authentication data and any padding to ensure total</span>
<span class="cm">   * size is a multiple of the AES block size */</span>
<span class="w">  </span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleAddAuthData</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">aadBuffSize</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">AES_BLOCK_SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pAadBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">aadBuffSize</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The operational data needed to perform the encrypt or decrypt operation is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">packetType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_PACKET_TYPE_FULL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="cm">/* In this example iv is 12 bytes. The implementation</span>
<span class="cm"> * will use the iv to generation the J0 block */</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pIvBuffer</span><span class="p">,</span><span class="w"> </span><span class="n">sampleIv</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleIv</span><span class="p">));</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleIv</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePayload</span><span class="p">);</span>
<span class="cm">/* For GCM hash offset and length are not required */</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pAdditionalAuthData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pAadBuffer</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>GMAC is supported using the same API and similar data structures as the general GCM
case shown above. However, for GMAC, the <code class="docutils literal notranslate"><span class="pre">messageLenToCipherInBytes</span></code> will be set
to 0.</p>
</div>
</section>
<section id="chained-cipher-and-hash-using-the-symmetric-data-plane-api">
<span id="qat-api-programmers-guide-qat-cryptoapi-chainedcipherhashsymdataplaneapi"></span><h3>Chained Cipher and Hash Using the Symmetric Data Plane API<a class="headerlink" href="#chained-cipher-and-hash-using-the-symmetric-data-plane-api" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the data plane symmetric API to perform a
<em>chained</em> cipher and hash operation. It encrypts some sample text using the AES-256
algorithm in CBC mode, and then performs an SHA-256 HMAC operation on the
ciphertext, writing the MAC to the buffer immediately after the ciphertext.</p>
<p>This example has been simplified to demonstrate the basics of how to use the API and
build the structures required. This example does not demonstrate the optimal way to
use the API to get the maximum performance for a particular implementation. Refer
to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for implementation specific documentation (for example, the <em>Intel®
Communications Chipset 8900 to 8920 Series Software Programmer’s Guide</em>) and
performance sample code for a guide on how to use the API for best performance.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/symdp_sample</span></code>.</p>
<p>Use of the data plane symmetric API follows some of the same basic steps as the
traditional symmetric API:</p>
<ul class="simple">
<li><p>Discover and start up the cryptographic service instance.</p></li>
<li><p>Register a callback function for the instance.</p></li>
<li><p>Create and initialize a session.</p></li>
<li><p>Enqueue the symmetric operation on the instance.</p></li>
<li><p>Submit the symmetric operation for processing.</p></li>
<li><p>Poll the instance for a response.</p></li>
<li><p>Tear down the session.</p></li>
<li><p>Stop the cryptographic service instance.</p></li>
</ul>
<p>Cryptographic service instances are discovered and started in the same way and
using the same API as the traditional symmetric use cases described in the
<a class="reference internal" href="#qat-api-programmers-guide-qat-cryptoapi-ciphersample"><span class="std std-ref">cipherSample</span></a> section.</p>
<p>The next step is to register a callback function for the cryptographic instance.
The function is called back in the context of the polling function when an asynchronous
operation has completed. This function can perform whatever processing is
appropriate to the application.</p>
<p>Callback differs from the traditional symmetric API, where the callback function is
registered for the session. See below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpRegCbFunc</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">symDpCallback</span><span class="p">);</span>
</pre></div>
</div>
<p>Create and initialize a session is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_HIGH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA256</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>

<span class="cm">/* Even though MAC follows immediately after the region to hash</span>
<span class="cm"> * digestIsAppended is set to false in this case to workaround</span>
<span class="cm"> * errata number IXA00378322 */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>

<span class="cm">/* Determine size of session context to allocate */</span>
<span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpSessionCtxGetSize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpSessionCtxGetSize</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionCtxSize</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Allocate session context */</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sessionCtx</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtxSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Initialize the session */</span>
<span class="w">  </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpInitSession</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpInitSession</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef LAC_HW_PRECOMPUTES</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Poll for hw pre-compute responses */</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icp_sal_CyPollDpInstance</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>In this example, data is stored in flat buffers (as opposed to scatter-gather lists). The
operational data in this case is shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_HIGH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_CIPHER_THEN_HASH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_AES_CBC</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_SHA256</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">sampleCipherKey</span><span class="p">);</span>

<span class="cm">/* Even though MAC follows immediately after the region to hash</span>
<span class="cm"> * digestIsAppended is set to false in this case to workaround</span>
<span class="cm"> * errata number IXA00378322 */</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>

<span class="cm">/* Determine size of session context to allocate */</span>
<span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpSessionCtxGetSize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpSessionCtxGetSize</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionCtxSize</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Allocate session context */</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sessionCtx</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtxSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Initialize the session */</span>
<span class="w">  </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpInitSession</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpInitSession</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef LAC_HW_PRECOMPUTES</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="cm">/* Poll for hw pre-compute responses */</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icp_sal_CyPollDpInstance</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>This request is then enqueued on the instance as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpEnqueueOp</span><span class="p">(</span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">);</span>
</pre></div>
</div>
<p>Other requests can now be enqueued before submitting all the requests to be
processed. Enqueued requests allow the cost of submitting a request (which can be
expensive, in terms of cycles, for some hardware-based implementations) to be
amortized over all enqueued requests on the instance. Once sufficient requests have
been enqueued they are all submitted for processing. See below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpPerformOpNow</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">);</span>
</pre></div>
</div>
<p>An alternative to calling the <code class="docutils literal notranslate"><span class="pre">cpaCySymDpPerformOpNow</span></code> function is to set
<code class="docutils literal notranslate"><span class="pre">performOpNow</span></code> to <code class="docutils literal notranslate"><span class="pre">CPA_TRUE</span></code> when calling the enqueue functions
(<code class="docutils literal notranslate"><span class="pre">cpaCySymDpEnqueueOp</span></code> or <code class="docutils literal notranslate"><span class="pre">cpaCySymDpEnqueueOpBatch</span></code>). This is illustrated in the section
<a class="reference internal" href="QAT_compressionAPI.html#qat-api-programmers-guide-qat-compressionapi-dcdataplaneapi"><span class="std std-ref">Data Compression Data Plane API</span></a>.</p>
<p>After submitting several requests and possibly doing other work (e.g., enqueuing
and submitting more requests), the application can poll for responses that invoke
the callback function registered with the instance. Refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for implementation specific documentation for information on the implementations of polling functions.</p>
<p>Once all requests associated with a session have been completed, the session can
be removed as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpRemoveSession</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">);</span>
</pre></div>
</div>
<p>Since cryptographic API v2.2, before removing the symmetric session context, it is
recommended to wait for the completion of any outstanding request using
<code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>. It is executed in the <code class="docutils literal notranslate"><span class="pre">symSessionWaitForInflightReq</span></code> call, which polls for the in-flight
requests.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">symSessionWaitForInflightReq</span><span class="p">(</span><span class="n">sessionCtx</span><span class="p">)</span>
</pre></div>
</div>
<p>Since Cryptographic API v2.2, two new functions have been implemented:
<code class="docutils literal notranslate"><span class="pre">cpaCySymUpdateSession</span></code> and <code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>.</p>
<ul class="simple">
<li><p>The function <code class="docutils literal notranslate"><span class="pre">cpaCySymUpdateSession</span></code> can be used to update certain parameters of
session like a cipher key, the cipher direction, and the authentication key.
<code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code> indicates whether there are outstanding requests on a
given session.</p></li>
<li><p>As a result of the implementation of this feature, the behavior of
<code class="docutils literal notranslate"><span class="pre">cpaCySymRemoveSession</span></code> has been changed. The <code class="docutils literal notranslate"><span class="pre">cpaCySymRemoveSession</span></code> fails if
there is an outstanding request for the session that the user is trying to remove.
As a result, it is recommended to wait for the completion of any outstanding
request, using <code class="docutils literal notranslate"><span class="pre">cpaCySymSessionInUse</span></code>, before removing a session.</p></li>
</ul>
</section>
<section id="tls-key-and-mgf-mask-generation">
<h3>TLS Key and MGF Mask Generation<a class="headerlink" href="#tls-key-and-mgf-mask-generation" title="Permalink to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Refer to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for the API manuals for full details of Key and Mask Generation operations.</p>
</div>
<ol class="arabic">
<li><p>Define a <em>Flat Buffer</em> callback function as per the API prototype.
If synchronous operation is preferred, instead simply pass <code class="docutils literal notranslate"><span class="pre">NULL</span></code> to the API for the
callback parameter.</p></li>
<li><p>Allocate memory for the operation.</p></li>
<li><p>Populate data for the appropriate operation data structure as per the API prototype.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Fill in the <em>Flat Buffers</em>, a pointer to data, and length.</p></li>
<li><p>Fill in the options for the operation required.</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Call the appropriate Key or Mask Generation API.</p></li>
<li><p>Complete the operation.</p></li>
</ol>
<p>The API for TLS key operations is based on the Transport Layer Security (TLS)
Protocol Version 1.1 standard, RFC 4346. Backward compatibility is supported with the
legacy Transport Layer Security (TLS) Protocol Version 1.0 standard, RFC 2246.
The user-defined label should be used for backward compatibility with the
client write key, server write key, and iv block. Refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
(<em>Intel® QAT Cryptographic API Reference Manual</em>) for details of populating <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code>,
the operation data structure.</p>
<p>The following sections describe examples of the parameter mapping to the
cryptographic API.</p>
<section id="setting-cpacykeygentlsopdata-structure-fields">
<h4>Setting CpaCyKeyGenTlsOpData Structure Fields<a class="headerlink" href="#setting-cpacykeygentlsopdata-structure-fields" title="Permalink to this heading"></a></h4>
<p>The Transport Layer Security (TLS) Protocol Version 1.1 standard, RFC 4346 (refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>),
section 6.3 <code class="docutils literal notranslate"><span class="pre">key_block</span></code> is described as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">key_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRF</span><span class="p">(</span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">master_secret</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;key expansion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">server_random</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SecurityParameters</span><span class="p">.</span><span class="n">client_random</span><span class="p">);</span>
</pre></div>
</div>
<p>This maps to the cryptographic API’s <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code> as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TLS Key-Material Derivation:

  tlsOp = CPA_CY_KEY_TLS_OP_KEY_MATERIAL_DERIVE
  secret = master secret key
  seed = server_random + client_random
  userLabel = NULL
</pre></div>
</div>
<p>Setting the <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code> structure fields for backward compatibility:</p>
<ol class="arabic">
<li><p>In the Transport Layer Security (TLS) Protocol Version 1.0 standard, RFC 2246 (refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>),
Section 6.3 <code class="docutils literal notranslate"><span class="pre">final_client_write_key</span></code> is described as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">final_client_write_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRF</span><span class="p">(</span><span class="n">client_write_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;client write key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">client_random</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">server_random</span><span class="p">)[</span><span class="mf">0..15</span><span class="p">]</span>
</pre></div>
</div>
<p>This maps to the cryptographic API’s <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code> as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TLS User Defined Derivation:

  tlsOp = CPA_CY_KEY_TLS_OP_USER_DEFINED
  secret = client_write_key
  seed = client_random + server_random
  userLabel = &quot;client write key&quot;
</pre></div>
</div>
</li>
<li><p>In the Transport Layer Security (TLS) Protocol v1.0 standard, RFC 2246 (refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>),
Section 6.3 <code class="docutils literal notranslate"><span class="pre">final_server_write_key</span></code> is described as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">final_server_write_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRF</span><span class="p">(</span><span class="n">server_write_key</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;server write key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">client_random</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">server_random</span><span class="p">)[</span><span class="mf">0..15</span><span class="p">]</span>
</pre></div>
</div>
<p>This maps to the cryptographic API’s <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code> as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TLS User Defined Derivation:

  tlsOp = CPA_CY_KEY_TLS_OP_USER_DEFINED
  secret = server_write_key
  seed = client_random + server_random
  userLabel = &quot;server write key&quot;
</pre></div>
</div>
</li>
<li><p>In the Transport Layer Security (TLS) Protocol Version 1.0 standard, RFC 2246 (refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>),
Section 6.3 <code class="docutils literal notranslate"><span class="pre">iv_block</span></code> is described as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">iv_block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PRF</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;IV block&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">client_random</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">server_random</span><span class="p">)[</span><span class="mf">0..15</span><span class="p">]</span>
</pre></div>
</div>
<p>This maps to the cryptographic API’s <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenTlsOpData</span></code> as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>TLS User Defined Derivation:

  tlsOp = CPA_CY_KEY_TLS_OP_USER_DEFINED
  secret = NULL
  seed = client_random + server_random
  userLabel = &quot;IV block&quot;
</pre></div>
</div>
</li>
</ol>
<p>Memory for the user label must be physically contiguous memory allocated by the
user. This memory must be available to the API for the duration of the operation.</p>
</section>
</section>
<section id="session-update-for-chained-cipher-and-hash-operation">
<h3>Session Update for Chained Cipher and Hash Operation<a class="headerlink" href="#session-update-for-chained-cipher-and-hash-operation" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the session update together with data plane
symmetric API to perform a <em>chained</em> cipher and hash operation. It performs a
KASUMI F9 hash operation on the sample text and then encrypts the sample text using
the KASUMI F8 algorithm. After the operation is complete, the cipher and
authentication keys are updated inside the session and the operation is performed
again with different keys.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example is simplified to demonstrate the basics of how to use the API and how to
build the structures required. This example does not demonstrate the optimal way to use the
API to get maximum performance for a particular implementation. Refer to <a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for implementation specific documentation and performance sample code for a guide on how to
use the API for best performance.</p>
</div>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/sym/update_sample</span></code>.</p>
<p>The following are the details of the steps performed in the sample:</p>
<ul>
<li><p>Cryptographic service instances are discovered and started in the same way and
using the same API as the traditional symmetric use cases described in the
<a class="reference internal" href="#qat-api-programmers-guide-qat-cryptoapi-ciphersample"><span class="std std-ref">cipherSample</span></a> section.</p></li>
<li><p>Next, register a callback function for the cryptographic instance.
The function is called back in the context of the polling function when an
asynchronous operation has completed. This function can perform whatever
processing is appropriate to the application. Note this differs from the traditional
symmetric API where the callback function is registered for the session.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpRegCbFunc</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="n">symDpCallback</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<section id="create-and-initialize-a-session">
<h4>Create and Initialize a Session<a class="headerlink" href="#create-and-initialize-a-session" title="Permalink to this heading"></a></h4>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionSetupData</span><span class="p">.</span><span class="n">sessionPriority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_PRIORITY_HIGH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">symOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_OP_ALGORITHM_CHAINING</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">algChainOrder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_ALG_CHAIN_ORDER_HASH_THEN_CIPHER</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_KASUMI_F8</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCipherKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cipherKeyLen</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">cipherSetupData</span><span class="p">.</span><span class="n">cipherDirection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_CIPHER_DIRECTION_ENCRYPT</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashAlgorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_KASUMI_F9</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">hashMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_HASH_MODE_AUTH</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">digestResultLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DIGEST_LENGTH</span><span class="p">;</span>

<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authKey</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">authKeyLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authKeyLen</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">hashSetupData</span><span class="p">.</span><span class="n">authModeSetupData</span><span class="p">.</span><span class="n">aadLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">additionalAuthData</span><span class="p">);</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">digestIsAppended</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="n">sessionSetupData</span><span class="p">.</span><span class="n">verifyDigest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">;</span>

<span class="cm">/* Determine size of session context to allocate */</span>
<span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpSessionCtxGetSize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpSessionCtxGetSize</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionCtxSize</span><span class="p">);</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Allocate session context */</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="n">sessionCtx</span><span class="p">,</span><span class="w"> </span><span class="n">sessionCtxSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Initialize the session */</span>
<span class="w">  </span><span class="n">PRINT_DBG</span><span class="p">(</span><span class="s">&quot;cpaCySymDpInitSession</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpInitSession</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionSetupData</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">sessionCtx</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In this example, data is stored in flat buffers (as opposed to scatter-gather lists). The
operational data in this case is the following:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">thisPhys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pOpData</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">instanceHandle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyInstHandle</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">sessionCtx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sessionCtx</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pCallbackTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">cryptoStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToCipherInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcLen</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hashStartSrcOffsetInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">messageLenToHashInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">srcLen</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">digestResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">srcLen</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">iv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pIvBuffer</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pIv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pIvBuffer</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">ivLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ivLen</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">additionalAuthData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pAdditionalAuthData</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">pAdditionalAuthData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pAdditionalAuthData</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">srcBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pSrcBuffer</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">srcBufferLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">dstBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sampleVirtToPhys</span><span class="p">(</span><span class="n">pDstBuffer</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">dstBufferLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">;</span>
</pre></div>
</div>
<p>This request is then enqueued on the instance as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpEnqueueOp</span><span class="p">(</span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="n">CPA_FALSE</span><span class="p">);</span>
</pre></div>
</div>
<p>Other requests can now be enqueued before submitting all the requests to be
processed. This allows the cost of submitting a request (which can be expensive, in
terms of cycles, for some hardware-based implementations) to be amortized over all
enqueued requests on the instance. Once sufficient requests have been enqueued
they are all submitted for processing. See example below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymDpPerformOpNow</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">);</span>
</pre></div>
</div>
<p>An alternative to calling the <code class="docutils literal notranslate"><span class="pre">cpaCySymDpPerformOpNow</span></code> function is to set
<code class="docutils literal notranslate"><span class="pre">performOpNow</span></code> to <code class="docutils literal notranslate"><span class="pre">CPA_TRUE</span></code> when calling the enqueue functions
(<code class="docutils literal notranslate"><span class="pre">cpaCySymDpEnqueueOp</span></code> or <code class="docutils literal notranslate"><span class="pre">cpaCySymDpEnqueueOpBatch</span></code>). This is illustrated in the
data compression data plane example.</p>
<p>After submitting a number of requests and possibly doing other work (e.g.
enqueuing and submitting more requests) the application can poll for responses
which will invoke the callback function registered with the instance. Refer to
<a class="reference internal" href="introduction.html#qat-api-programmers-guide-introduction-related-documentation-references"><span class="std std-ref">Related Documents and References</span></a>
for implementation specific documentation for information on the implementations
polling functions.</p>
<p>After the operation is complete, the cipher key and authentication key are updated in
the existing session via session update API as shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sessionUpdateData</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_SYM_SESUPD_CIPHER_KEY</span><span class="p">;</span>
<span class="n">sessionUpdateData</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CPA_CY_SYM_SESUPD_AUTH_KEY</span><span class="p">;</span>
<span class="n">sessionUpdateData</span><span class="p">.</span><span class="n">pCipherKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pCipherKey</span><span class="p">;</span>
<span class="n">sessionUpdateData</span><span class="p">.</span><span class="n">authKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">authKey</span><span class="p">;</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCySymUpdateSession</span><span class="p">(</span><span class="n">sessionCtx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sessionUpdateData</span><span class="p">);</span>
</pre></div>
</div>
<p>With the keys changed, the chained cipher and hash operation is performed again,
just as described above.</p>
<p>Once all requests associated with a session have been completed, the session can
be removed.</p>
</section>
</section>
<section id="hkdf-use-case">
<h3>HKDF Use Case<a class="headerlink" href="#hkdf-use-case" title="Permalink to this heading"></a></h3>
<p>This section contains sample code that demonstrates the usage of the symmetric API,
specifically using this API to perform hash-based message authentication code key
derivation function (HKDF) operations. It performs HKDF Extract and Expand, and
Extract and Expand Label operation without and with sublabels (KEY and IV).</p>
<p>The simplified code example below is simplified and demonstrates how to use the API
and build the structures required. This example does not demonstrate the optimal way
to use the API to get maximum performance for implementation.</p>
<p>This sample is located in <code class="docutils literal notranslate"><span class="pre">/quickassist/lookaside/access_layer/src/sample_code/functional/sym/hkdf_sample</span></code>.</p>
<section id="instance-configuration-and-memory-allocation">
<h4>Instance Configuration and Memory Allocation<a class="headerlink" href="#instance-configuration-and-memory-allocation" title="Permalink to this heading"></a></h4>
<p>Cryptographic service instances are discovered and started in the same way and using
the same API as the traditional symmetric use cases.</p>
<ol class="arabic">
<li><p>If the instance is polled, start the polling thread.
Polling is done in an implementation-dependent manner.</p></li>
<li><p>Allocate memory for HKDF operation data:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qaeMemAllocNUMA</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyKeyGenHKDFOpData</span><span class="p">),</span><span class="w"> </span><span class="n">instanceInfo2</span><span class="p">.</span><span class="n">nodeAffinity</span><span class="p">,</span><span class="w"> </span><span class="n">BYTE_ALIGNMENT_64</span><span class="p">);</span>
</pre></div>
</div>
<p>This structure must be allocated with USDM to be pinned in physical memory.</p>
</li>
<li><p>Allocate memory for HKDF output data. Output data is <code class="docutils literal notranslate"><span class="pre">CpaFlatBuffer</span></code> type:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pHkdfData</span><span class="p">,</span><span class="w"> </span><span class="n">hkdfDataSize</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="hkdf-extract-expand-operation">
<h4>HKDF Extract Expand Operation<a class="headerlink" href="#hkdf-extract-expand-operation" title="Permalink to this heading"></a></h4>
<p>To perform an Extract Expand operation, go to the <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenHKDFOpData</span></code> structure,
and set <code class="docutils literal notranslate"><span class="pre">hkdfKeyOp</span></code> to <code class="docutils literal notranslate"><span class="pre">CPA_CY_HKDF_KEY_EXTRACT_EXPAND</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Provide the lengths <code class="docutils literal notranslate"><span class="pre">seedLen</span></code>, <code class="docutils literal notranslate"><span class="pre">secretLen</span></code>, and <code class="docutils literal notranslate"><span class="pre">infoLen</span></code> and copy all data into the
seed, secret, and info tables.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hkdfKeyOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_HKDF_KEY_EXTRACT_EXPAND</span><span class="p">;</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seedLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ikm</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">ikm</span><span class="p">,</span><span class="w"> </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seedLen</span><span class="p">);</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secretLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">slt</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">slt</span><span class="p">,</span><span class="w"> </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secretLen</span><span class="p">);</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">infoLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">inf</span><span class="p">,</span><span class="w"> </span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">infoLen</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="hkdf-extract-expand-label-operation">
<h4>HKDF Extract Expand Label Operation<a class="headerlink" href="#hkdf-extract-expand-label-operation" title="Permalink to this heading"></a></h4>
<p>To perform an Extract, Expand Label operation:</p>
<ol class="arabic simple">
<li><p>Go to the <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenHKDFOpData</span></code> structure and set <code class="docutils literal notranslate"><span class="pre">hkdfKeyOp</span></code> to
<code class="docutils literal notranslate"><span class="pre">CPA_CY_HKDF_KEY_EXTRACT_EXPAND_LABEL</span></code>.</p></li>
<li><p>Provide the lengths <code class="docutils literal notranslate"><span class="pre">seedLen</span></code>, <code class="docutils literal notranslate"><span class="pre">secretLen</span></code>, and <code class="docutils literal notranslate"><span class="pre">infoLen</span></code> and copy all data into the
seed, secret, and info tables.</p></li>
<li><p>Set the number of labels in the <code class="docutils literal notranslate"><span class="pre">numLabels</span></code> field.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">label[0].labelLen</span></code>.</p></li>
<li><p>Copy label data into the <code class="docutils literal notranslate"><span class="pre">label[0].label</span></code> table.</p></li>
<li><p>Finally, set the <code class="docutils literal notranslate"><span class="pre">label[0].sublabelFlag</span></code> field to <code class="docutils literal notranslate"><span class="pre">0x00</span></code> to disable generating
sublabels.</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hkdfKeyOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_HKDF_KEY_EXTRACT_EXPAND_LABEL</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seedLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">seed_label</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">seed_label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">seed_label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secretLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">secret_label</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">secret_label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">secret_label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">numLabels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">labelLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sublabelFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x00</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="hkdf-extract-expand-label-and-sublabels-operation">
<h4>HKDF Extract Expand Label and Sublabels Operation<a class="headerlink" href="#hkdf-extract-expand-label-and-sublabels-operation" title="Permalink to this heading"></a></h4>
<p>To perform an Extract, Expand Label and Sublabels operation:</p>
<ol class="arabic simple">
<li><p>Go to the <code class="docutils literal notranslate"><span class="pre">CpaCyKeyGenHKDFOpData</span></code> structure and set <code class="docutils literal notranslate"><span class="pre">hkdfKeyOp</span></code> to
<code class="docutils literal notranslate"><span class="pre">CPA_CY_HKDF_KEY_EXTRACT_EXPAND_LABEL</span></code>.</p></li>
<li><p>Provide the lengths <code class="docutils literal notranslate"><span class="pre">seedLen</span></code>, <code class="docutils literal notranslate"><span class="pre">secretLen</span></code>, and <code class="docutils literal notranslate"><span class="pre">infoLen</span></code> and copy all data into the
seed, secret, and info tables.</p></li>
<li><p>Set the number of labels in the <code class="docutils literal notranslate"><span class="pre">numLabels</span></code> field.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">label[0].labelLen</span></code>.</p></li>
<li><p>Copy label data into the <code class="docutils literal notranslate"><span class="pre">label[0].label</span></code> table.</p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">label[0].sublabelFlag</span></code> and <code class="docutils literal notranslate"><span class="pre">label[0].sublabelFlag</span></code> field as shown
below to generate Key and IV sublabels.</p></li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">hkdfKeyOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_HKDF_KEY_EXTRACT_EXPAND_LABEL</span><span class="p">;</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seedLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">seed_label</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">seed_label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">seed_label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secretLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">secret_label</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">secret</span><span class="p">,</span><span class="w"> </span><span class="n">secret_label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">secret_label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">numLabels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="p">));</span>

<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">labelLen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sublabelFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_CY_HKDF_SUBLABEL_KEY</span><span class="p">;</span>
<span class="n">pOpData</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sublabelFlag</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">CPA_CY_HKDF_SUBLABEL_IV</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="perform-hkdf-operation">
<h3>Perform HKDF Operation<a class="headerlink" href="#perform-hkdf-operation" title="Permalink to this heading"></a></h3>
<p>The crypto instance must be specified in the <code class="docutils literal notranslate"><span class="pre">instanceHandle</span></code> to execute the HKDF
operation. When the operation is performed asynchronously, the callback function and
callback tag should be set in the <code class="docutils literal notranslate"><span class="pre">pKeyGenCb</span></code> and <code class="docutils literal notranslate"><span class="pre">pCallbackTag</span></code> arguments.
Operational data is provided in <code class="docutils literal notranslate"><span class="pre">pKeyGenTlsOpData</span></code>, and <code class="docutils literal notranslate"><span class="pre">CpaCyKeyHKDFCipherSuite</span></code>
must be chosen. The output is passed to the <code class="docutils literal notranslate"><span class="pre">CpaFlatBuffer</span></code>. All generated values are
arranged one after the other in a single buffer. Depending on what operations are
performed, the buffer length should be adjusted. See below example.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">cpaCyKeyGenTls3</span><span class="p">(</span><span class="n">cyInstHandle</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Instance handle */</span>
<span class="w">                </span><span class="n">hkdfSampleCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Callback function */</span>
<span class="w">                </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Callback tag */</span>
<span class="w">                </span><span class="n">pOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* HKDF operational data */</span>
<span class="w">                </span><span class="n">CPA_CY_HKDF_TLS_AES_128_GCM_SHA256</span><span class="p">,</span><span class="w"> </span><span class="cm">/* HKDF cipher suite */</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">hkdfOut</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Output buffer */</span>
</pre></div>
</div>
</section>
</section>
<section id="using-the-diffie-hellman-api">
<h2>Using the Diffie-Hellman API<a class="headerlink" href="#using-the-diffie-hellman-api" title="Permalink to this heading"></a></h2>
<p>This example demonstrates the usage of the Diffie-Hellman API.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/asym/diffie_hellman_sample</span></code>.</p>
<p>The following steps are carried out:</p>
<ul class="simple">
<li><p>The example uses the API asynchronously; therefore, you must define a Diffie-Hellman callback function per the API prototype.</p></li>
<li><p>Instance, discovery, and start-up are made in a way similar to that defined for the
symmetric examples above.</p></li>
<li><p>The function <code class="docutils literal notranslate"><span class="pre">sampleDhPerformOp</span></code> is called, which does the following:</p>
<ul>
<li><p>Allocate memory for the operation and populate data for the appropriate DH
phase 1 operation data structure to generate the public value. The fields to be
allocated and populated are the <code class="docutils literal notranslate"><span class="pre">primeP</span></code>, the <code class="docutils literal notranslate"><span class="pre">baseG</span></code>, and the <code class="docutils literal notranslate"><span class="pre">privateValueX</span></code>.
Space must also be allocated for the output, which is the public value (PV).</p></li>
</ul>
</li>
</ul>
<p>See below example to allocate memory and populate operational data.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaDhOpDataP1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyDhPhase1KeyGenOpData</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate input buffers for phase 1 and copy data. Input to DH</span>
<span class="cm"> * phase 1 includes the prime (primeP), the base g (baseG) and</span>
<span class="cm"> * a random private value (privateValueX) */</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">memset</span><span class="p">(</span><span class="n">pCpaDhOpDataP1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyDhPhase1KeyGenOpData</span><span class="p">));</span>

<span class="w">  </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">primeP</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">primeP_768</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">primeP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">primeP_768</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">primeP</span><span class="p">.</span><span class="n">pData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">primeP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">primeP_768</span><span class="p">,</span>
<span class="w">    </span><span class="k">sizeof</span><span class="p">(</span><span class="n">primeP_768</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">baseG</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">baseG1</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">baseG</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">baseG1</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">baseG</span><span class="p">.</span><span class="n">pData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">baseG</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">baseG1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">baseG1</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">CPA_STATUS_SUCCESS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">privateValueX</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">privateValueX</span><span class="p">);</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">privateValueX</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">privateValueX</span><span class="p">));</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">privateValueX</span><span class="p">.</span><span class="n">pData</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">pCpaDhOpDataP1</span><span class="o">-&gt;</span><span class="n">privateValueX</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">privateValueX</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">privateValueX</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Invoke the phase 1 operation as shown below, which performs the modular exponentiation such that
<em>PV = (baseG ^ privateValueX) mod primeP</em>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the case of phase 1, the operation is invoked synchronously, hence the <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
pointer for the callback function.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyDhKeyGenPhase2Secret</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTagPh2</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Pointer to the complete variable */</span>
<span class="w">    </span><span class="n">pCpaDhOpDataP2</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Structure containing p, the public value &amp; x */</span>
<span class="w">    </span><span class="n">pOctetStringSecretKey</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Private key (output of the function) */</span>
</pre></div>
</div>
<p>In a real-world implementation of a key exchange protocol, the public value generated
above would now be shared with another party, <em>B</em>. This example uses this public value
to go on and invoke the second phase operation. First allocate memory for the secret
value, setup the operational data for the phase 2 operation, and then perform that
operation. This operation is invoked asynchronously, taking the callback function
defined earlier as a parameter. See below example.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyDhKeyGenPhase2Secret</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function */</span>
<span class="w">    </span><span class="n">pCallbackTagPh2</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Pointer to the complete variable */</span>
<span class="w">    </span><span class="n">pCpaDhOpDataP2</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Structure containing p, the public value &amp; x*/</span>
<span class="w">    </span><span class="n">pOctetStringSecretKey</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Private key (output of the function) */</span>
</pre></div>
</div>
<p>Finally, clean up by freeing up memory, stopping the instance, etc.</p>
<section id="prime-number-testing">
<h3>Prime Number Testing<a class="headerlink" href="#prime-number-testing" title="Permalink to this heading"></a></h3>
<p>This example demonstrates the usage of the prime number testing API.</p>
<p>These samples are located in <code class="docutils literal notranslate"><span class="pre">/asym/prime_sample</span></code>.</p>
<p>The following steps are carried out:</p>
<ul class="simple">
<li><p>The API is used asynchronously, therefore, a callback function is defined as per the
API prototype.</p></li>
<li><p>Instance, discovery, and start-up is made in a way similar to that defined for the
symmetric examples above.</p></li>
<li><p>The function <code class="docutils literal notranslate"><span class="pre">primePerformOp</span></code> is called, which does the following:</p>
<ul>
<li><p>Allocate memory for the operation.</p></li>
<li><p>Populate data for the appropriate input fields and perform the operation. The
fields populated include the following:</p>
<ul>
<li><p>Prime Candidate.</p></li>
<li><p>Whether to perform the greatest common divisor (GCD) test.</p></li>
<li><p>Whether to perform the Fermat test.</p></li>
<li><p>Number of Miller-Rabin rounds.</p></li>
<li><p>Whether to perform Lucas test.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">primeCandidate</span><span class="p">.</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pPrime</span><span class="p">;</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">primeCandidate</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">samplePrimeP_768</span><span class="p">);</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">performGcdTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">performFermatTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">numMillerRabinRounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NB_MR_ROUNDS</span><span class="p">;</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">millerRabinRandomInput</span><span class="p">.</span><span class="n">pData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pMR</span><span class="p">;</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">millerRabinRandomInput</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">MR</span><span class="p">);</span>
<span class="n">pPrimeTestOpData</span><span class="o">-&gt;</span><span class="n">performLucasTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CPA_TRUE</span><span class="p">;</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyPrimeTest</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyPrimeTestCbFunc</span><span class="p">)</span><span class="n">primeCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function */</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">complete</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Callback tag */</span>
<span class="w">    </span><span class="n">pPrimeTestOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Operation data */</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">testPassed</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Return value: true if the number is probably a prime, false if it is not a prime */</span>
</pre></div>
</div>
<p>Finally, statistics are queried and the service stopped.</p>
</section>
</section>
<section id="using-the-sm2-api">
<h2>Using the SM2 API<a class="headerlink" href="#using-the-sm2-api" title="Permalink to this heading"></a></h2>
<p>This example demonstrates the usage of the SM2 API.</p>
<p>The following steps are carried out:</p>
<ul class="simple">
<li><p>The example contains synchronous and asynchronous API. For the latter one, you must
define a proper callback function per the API prototype for different SM2 operations.</p></li>
<li><p>Instance, discovery, and start-up are made in a way similar to that defined for the
symmetric examples above.</p></li>
<li><p>This sample involves sign/verify, encryption/decryption, key exchange, point
multiplication/verify.</p></li>
</ul>
<section id="sm2-digital-signature-generation-and-verification">
<h3>SM2 Digital Signature Generation and Verification<a class="headerlink" href="#sm2-digital-signature-generation-and-verification" title="Permalink to this heading"></a></h3>
<p>This operation is to sign a given message and output its digital signature (r,s) then
verify (r,s).</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2SignPerformOp</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate data for input buffer which includes scalar
multiplier <code class="docutils literal notranslate"><span class="pre">k</span></code>, digest of the message <code class="docutils literal notranslate"><span class="pre">e</span></code> and private key <code class="docutils literal notranslate"><span class="pre">d</span></code>.</p></li>
<li><p>Allocate memory for output buffer which includes signature <code class="docutils literal notranslate"><span class="pre">r</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code>.</p></li>
<li><p>Call function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2Sign</span></code> for sign operation.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2SignOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2SignOpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2SignOpData</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2SignOpData</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2SignOpData</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pR</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pS</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2Sign</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyEcsm2SignCbFunc</span><span class="p">)</span><span class="n">asymSignCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2SignOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Structure containing k, d and e */</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">signStatus</span><span class="p">,</span><span class="w"> </span><span class="cm">/* signStatus indicates if the result is valid */</span>
<span class="w">    </span><span class="n">pR</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Signature r (function output) */</span>
<span class="w">    </span><span class="n">pS</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Signature s (function output) */</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2VerifyPerformOp</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate data for the input buffer which includes digest of
the message <code class="docutils literal notranslate"><span class="pre">e</span></code>, signature <code class="docutils literal notranslate"><span class="pre">r</span></code> and <code class="docutils literal notranslate"><span class="pre">s</span></code>, <em>x</em> coordinate of public key and <em>y</em> coordinate
of public key.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2Verify</span></code> for signature verification operation.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2VerifyOpData</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">r</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="o">-&gt;</span><span class="n">xP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xP</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2VerifyOpData</span><span class="o">-&gt;</span><span class="n">yP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">yPA</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2Verify</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyEcsm2VerifyCbFunc</span><span class="p">)</span><span class="n">asymVerifyCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2VerifyOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Verify request data*/</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">verifyStatus</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Verify status */</span>
</pre></div>
</div>
</section>
<section id="sm2-public-key-encryption">
<h3>SM2 Public Key Encryption<a class="headerlink" href="#sm2-public-key-encryption" title="Permalink to this heading"></a></h3>
<p>This operation is to encrypt a given message then decrypt the cipher and compare to
the given message.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2EncPerformOp</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate data for the input buffer which includes scalar
multiplier <code class="docutils literal notranslate"><span class="pre">k</span></code>, <em>x</em> coordinate of public key <code class="docutils literal notranslate"><span class="pre">xP</span></code> and <em>y</em> coordinate of public key <code class="docutils literal notranslate"><span class="pre">yP</span></code>.</p></li>
<li><p>Allocate memory for the output buffer which includes <em>x</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]G</span> <span class="pre">x1</span></code>, <em>y</em>
coordinate of <code class="docutils literal notranslate"><span class="pre">[k]G</span> <span class="pre">y1</span></code>, <em>x</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]Pb</span> <span class="pre">x2</span></code> and <em>y</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]Pb</span> <span class="pre">y2</span></code>.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2Encrypt</span></code> for encryption operation.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2EncryptOpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOpData</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOpData</span><span class="o">-&gt;</span><span class="n">xP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xP</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOpData</span><span class="o">-&gt;</span><span class="n">yP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">yP</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2EncryptOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOutputData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOutputData</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOutputData</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2EncOutputData</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2Encrypt</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymEncCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2EncOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Encryption request data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2EncOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Encryption response data */</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2DecPerformOp</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate data for the input buffer which includes private key
<code class="docutils literal notranslate"><span class="pre">d</span></code>, <em>x</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]G</span> <span class="pre">x1</span></code> and <em>y</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]G</span> <span class="pre">y1</span></code>.</p></li>
<li><p>Allocate memory for the output buffer which includes <em>x</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]Pb</span> <span class="pre">x2</span></code> and
<em>y</em> coordinate of <code class="docutils literal notranslate"><span class="pre">[k]Pb</span> <span class="pre">y2</span></code>.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2Decrypt</span></code> for decryption operation.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">sm3</span></code> and <code class="docutils literal notranslate"><span class="pre">hashCheck</span></code> to check correctness of decryption.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2DecryptOpData</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOpData</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOpData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOpData</span><span class="o">-&gt;</span><span class="n">y1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2DecryptOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOutputData</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2DecOutputData</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2Decrypt</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymDecCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2DecOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Decryption request data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2DecOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Decryption response data */</span>

<span class="n">sm3</span><span class="p">(</span><span class="n">pDecOutputData</span><span class="p">,</span><span class="w"> </span><span class="n">MESSAGE_LEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">,</span><span class="w"> </span><span class="n">pHashBuffer</span><span class="p">);</span>
<span class="n">hashCheck</span><span class="p">(</span><span class="n">pC3Buffer</span><span class="p">,</span><span class="w"> </span><span class="n">pHashBuffer</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="sm2-key-exchange">
<h3>SM2 Key Exchange<a class="headerlink" href="#sm2-key-exchange" title="Permalink to this heading"></a></h3>
<p>This operation is to exchange key between the <em>A</em> side and <em>B</em> side, and check if the shared
keys are the same.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2KeyExPerformOp</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate the phase 1 input buffer which includes scalar multiplier <code class="docutils literal notranslate"><span class="pre">r</span></code> for the <em>A</em> side and <em>B</em>
side separately.</p></li>
<li><p>Allocate the phase 1 output buffer which includes <em>x</em> coordinate of a point on the
curve <code class="docutils literal notranslate"><span class="pre">x</span></code> and <em>y</em> coordinate of a point on the curve <code class="docutils literal notranslate"><span class="pre">y</span></code> for the <em>A</em> side and <em>B</em> side
separately.</p></li>
<li><p>Call function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2KeyExPhase1</span></code> for the <em>A</em> side and <em>B</em> side separately.</p></li>
<li><p>Allocate the phase 2 input buffer which includes scalar multiplier <code class="docutils literal notranslate"><span class="pre">r</span></code>, private key <code class="docutils literal notranslate"><span class="pre">d</span></code>,
<em>x</em> coordinate of a point on the curve from other side <code class="docutils literal notranslate"><span class="pre">x1</span></code>, <em>x</em> coordinate of a point
on the curve from phase 1 <code class="docutils literal notranslate"><span class="pre">x2</span></code>, <em>y</em> coordinate of a point on the curve from phase
1 <code class="docutils literal notranslate"><span class="pre">y2</span></code>, <em>x</em> coordinate of public key from other side <code class="docutils literal notranslate"><span class="pre">xP</span></code> and <em>y</em> coordinate of public
key from other side <code class="docutils literal notranslate"><span class="pre">yP</span></code> for the <em>A</em> side and <em>B</em> side separately.</p></li>
<li><p>Allocate the phase 2 output buffer which includes <em>x</em> coordinate of a point on the
curve <code class="docutils literal notranslate"><span class="pre">x</span></code> and <em>y</em> coordinate of a point on the curve <code class="docutils literal notranslate"><span class="pre">y</span></code> for the <em>A</em> side and <em>B</em> side
separately.</p></li>
<li><p>Call function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2KeyExPhase2</span></code> for the <em>A</em> side and <em>B</em> side separately.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1AOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExPhase1OpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1AOpData</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rA</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1BOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExPhase1OpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1BOpData</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rB</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2KeyExPhase1</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span>
<span class="w">    </span><span class="n">asymKeyExPhase1Callback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase1AOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Key exchange p1 request data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Key exchange p1 response data */</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2KeyExPhase1</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span>
<span class="w">    </span><span class="n">asymKeyExPhase1Callback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase1BOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Key exchange p1 request data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Key exchange p1 request data */</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExPhase2OpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rA</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dA</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase1BOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">xP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xPB</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="o">-&gt;</span><span class="n">yP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">yPB</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExPhase2OpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rB</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dB</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">x1</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">x2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">y2</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">pCpaEcsm2KeyExPhase1AOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">dataLenInBytes</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">xP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xPA</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="o">-&gt;</span><span class="n">yP</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">yPA</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2AOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOutputData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2KeyExOutputData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOutputData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pCpaEcsm2KeyExPhase2BOutputData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2KeyExPhase2</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymKeyExPhase2Callback</span><span class="p">,</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data; */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase2AOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Key exchange p2 request data, containing r,d,x1,x2,y2,xp,yp */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase2AOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Key exchange p2 response data */</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2KeyExPhase2</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyGenFlatBufCbFunc</span><span class="p">)</span><span class="n">asymKeyExPhase2Callback</span><span class="p">,</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase2BOpData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Key exchange p2 request data containing r,d,x1,y1,x2,y2,xp,yp */</span>
<span class="w">    </span><span class="n">pCpaEcsm2KeyExPhase2BOutputData</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Key exchange p2 response data */</span>
</pre></div>
</div>
</section>
<section id="sm2-elliptic-curve-point">
<h3>SM2 Elliptic Curve Point<a class="headerlink" href="#sm2-elliptic-curve-point" title="Permalink to this heading"></a></h3>
<p>This operation is to calculate a point on the curve according to a given random
number and verify if the point <em>(x,y)</em> is on the curve or not.</p>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2PointMultiply</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate date for input buffer which includes scalar
multiplier <code class="docutils literal notranslate"><span class="pre">k</span></code>, <em>x</em> coordinate of a point on the curve <code class="docutils literal notranslate"><span class="pre">x</span></code> and <em>y</em> coordinate of a point
on the curve <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p></li>
<li><p>Allocate memory for output buffer which includes <em>x</em> coordinate of the resulting
point multiplication <code class="docutils literal notranslate"><span class="pre">pXk</span></code> and <em>y</em> coordinate of the resulting point multiplication
<code class="docutils literal notranslate"><span class="pre">pYk</span></code>.</p></li>
<li><p>Call function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2PointMultiply</span></code> for point multiply operation.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2PointMultiplyOpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">xP</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">yP</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXk</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaFlatBuffer</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pYk</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaFlatBuffer</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXk</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pYk</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2PointMultiply</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyEcPointMultiplyCbFunc</span><span class="p">)</span>
<span class="w">    </span><span class="n">asymPointMultCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data; */</span>
<span class="w">    </span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Point multiplication request data */</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">multiplyStatus</span><span class="p">,</span>
<span class="w">    </span><span class="n">pXk</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Point multiplication response data */</span>
<span class="w">    </span><span class="n">pYk</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Point multiplication response data */</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2GeneratortMultiply</span></code> provisions parts of the example
implementation, which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate date for the input buffer which includes the scalar
multiplier <code class="docutils literal notranslate"><span class="pre">k</span></code>.</p></li>
<li><p>Allocate memory for the output buffer which includes <em>x</em> coordinate of the resulting
point multiplication <code class="docutils literal notranslate"><span class="pre">pXk</span></code> and <em>y</em> coordinate of the resulting point multiplication
<code class="docutils literal notranslate"><span class="pre">pYk</span></code>.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2GeneratorMultiply</span></code> for generator multiply
operation.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2GeneratorMultiplyOpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">k</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXk</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaFlatBuffer</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pYk</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaFlatBuffer</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pXk</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pYk</span><span class="o">-&gt;</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="n">GFP_SM2_SIZE_IN_BYTE</span><span class="p">);</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2GeneratorMultiply</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyEcPointMultiplyCbFunc</span><span class="p">)</span><span class="w"> </span><span class="n">asymGeneratorMultCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data; */</span>
<span class="w">    </span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Generator multiplication request data */</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">multiplyStatus</span><span class="p">,</span>
<span class="w">    </span><span class="n">pXk</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Generator multiplication response data */</span>
<span class="w">    </span><span class="n">pYk</span><span class="p">);</span><span class="w"> </span><span class="cm">/* Generator multiplication response data */</span>
</pre></div>
</div>
<p>The function <code class="docutils literal notranslate"><span class="pre">sampleEcsm2PointVerify</span></code> provisions parts of the example implementation,
which does the following:</p>
<ul class="simple">
<li><p>Allocate memory and populate date for the input buffer which includes <em>x</em>
coordinate of a point on the curve <code class="docutils literal notranslate"><span class="pre">x</span></code> and <em>y</em> coordinate of a point on the curve
<code class="docutils literal notranslate"><span class="pre">y</span></code>.</p></li>
<li><p>Call the function <code class="docutils literal notranslate"><span class="pre">cpaCyEcsm2PointVerify</span></code> for EC point verification.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OS_MALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">CpaCyEcsm2PointVerifyOpData</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PHYS_CONTIG_ALLOC</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opData</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">y</span><span class="p">));</span>

<span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cpaCyEcsm2PointVerify</span><span class="p">(</span>
<span class="w">    </span><span class="n">cyInstHandle</span><span class="p">,</span>
<span class="w">    </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">CpaCyEcPointVerifyCbFunc</span><span class="p">)</span><span class="w"> </span><span class="n">asymPointVerifyCallback</span><span class="p">,</span><span class="w"> </span><span class="cm">/* CB function*/</span>
<span class="w">    </span><span class="n">pCallbackTag</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Opaque user data */</span>
<span class="w">    </span><span class="n">opData</span><span class="p">,</span><span class="w"> </span><span class="cm">/* Point verify request data */</span>
<span class="w">    </span><span class="o">&amp;</span><span class="n">verifyStatus</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally, statistics are queried and the service stopped.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="baseAPI.html" class="btn btn-neutral float-left" title="Base API and API Conventions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="QAT_compressionAPI.html" class="btn btn-neutral float-right" title="Intel® QAT Data Compression API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Intel Corporation.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>